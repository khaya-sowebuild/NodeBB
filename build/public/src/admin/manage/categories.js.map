{"version":3,"sources":["public/src/admin/manage/categories.js"],"names":["define","serialize","translator","Benchpress","Categories","newCategoryId","sortables","init","socket","emit","error","payload","app","alertError","message","render","$","on","throwCreateModal","$this","this","cid","attr","parentEl","parents","disabled","hasClass","children","find","map","get","toggle","concat","el","toggleClass","closest","toggleAll","expand","err","categories","parse","html","modal","bootbox","dialog","title","buttons","save","label","className","callback","submit","formData","serializeObject","description","icon","uid","user","create","check","parentSelect","prop","val","removeAttr","data","alert","alert_id","type","timeout","ajaxify","go","container","length","translate","text","addClass","appendTo","renderList","cids","forEach","refresh","itemDidAdd","e","to","dataset","itemDragDidEnd","isCategoryUpdate","parseInt","newIndex","oldIndex","parentCategory","from","modified","i","list","toArray","len","order","item","parentCid","parentId","count","category","idx","parent","name","translated","continueRender","append","x","numCategories","Sortable","group","animation","handle","dataIdAttr","ghostClass","onAdd","onEnd"],"mappings":"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","file":"public/src/admin/manage/categories.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('admin/manage/categories', ['vendor/jquery/serializeObject/jquery.ba-serializeobject.min', 'translator', 'benchpress'], function (serialize, translator, Benchpress) {\r\n\tvar\tCategories = {};\r\n\tvar newCategoryId = -1;\r\n\tvar sortables;\r\n\r\n\tCategories.init = function () {\r\n\t\tsocket.emit('admin.categories.getAll', function (error, payload) {\r\n\t\t\tif (error) {\r\n\t\t\t\treturn app.alertError(error.message);\r\n\t\t\t}\r\n\r\n\t\t\tCategories.render(payload);\r\n\t\t});\r\n\r\n\t\t$('button[data-action=\"create\"]').on('click', Categories.throwCreateModal);\r\n\r\n\t\t// Enable/Disable toggle events\r\n\t\t$('.categories').on('click', 'button[data-action=\"toggle\"]', function () {\r\n\t\t\tvar $this = $(this);\r\n\t\t\tvar cid = $this.attr('data-cid');\r\n\t\t\tvar parentEl = $this.parents('li[data-cid=\"' + cid + '\"]');\r\n\t\t\tvar disabled = parentEl.hasClass('disabled');\r\n\r\n\t\t\tvar children = parentEl.find('li[data-cid]').map(function () {\r\n\t\t\t\treturn $(this).attr('data-cid');\r\n\t\t\t}).get();\r\n\r\n\t\t\tCategories.toggle([cid].concat(children), !disabled);\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\t$('.categories').on('click', '.toggle', function () {\r\n\t\t\tvar el = $(this);\r\n\t\t\tel.find('i').toggleClass('fa-minus').toggleClass('fa-plus');\r\n\t\t\tel.closest('[data-cid]').find('> ul[data-cid]').toggleClass('hidden');\r\n\t\t});\r\n\r\n\t\t$('#collapse-all').on('click', function () {\r\n\t\t\ttoggleAll(false);\r\n\t\t});\r\n\r\n\t\t$('#expand-all').on('click', function () {\r\n\t\t\ttoggleAll(true);\r\n\t\t});\r\n\r\n\t\tfunction toggleAll(expand) {\r\n\t\t\tvar el = $('.categories .toggle');\r\n\t\t\tel.find('i').toggleClass('fa-minus', expand).toggleClass('fa-plus', !expand);\r\n\t\t\tel.closest('[data-cid]').find('> ul[data-cid]').toggleClass('hidden', !expand);\r\n\t\t}\r\n\t};\r\n\r\n\tCategories.throwCreateModal = function () {\r\n\t\tsocket.emit('admin.categories.getNames', {}, function (err, categories) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tBenchpress.parse('admin/partials/categories/create', {\r\n\t\t\t\tcategories: categories,\r\n\t\t\t}, function (html) {\r\n\t\t\t\tvar modal = bootbox.dialog({\r\n\t\t\t\t\ttitle: '[[admin/manage/categories:alert.create]]',\r\n\t\t\t\t\tmessage: html,\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\tsave: {\r\n\t\t\t\t\t\t\tlabel: '[[global:save]]',\r\n\t\t\t\t\t\t\tclassName: 'btn-primary',\r\n\t\t\t\t\t\t\tcallback: submit,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\r\n\t\t\t\tfunction submit() {\r\n\t\t\t\t\tvar formData = modal.find('form').serializeObject();\r\n\t\t\t\t\tformData.description = '';\r\n\t\t\t\t\tformData.icon = 'fa-comments';\r\n\t\t\t\t\tformData.uid = app.user.uid;\r\n\r\n\t\t\t\t\tCategories.create(formData);\r\n\t\t\t\t\tmodal.modal('hide');\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$('#cloneChildren').on('change', function () {\r\n\t\t\t\t\tvar check = $(this);\r\n\t\t\t\t\tvar parentSelect = $('#parentCid');\r\n\r\n\t\t\t\t\tif (check.prop('checked')) {\r\n\t\t\t\t\t\tparentSelect.attr('disabled', 'disabled');\r\n\t\t\t\t\t\tparentSelect.val('');\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tparentSelect.removeAttr('disabled');\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\tmodal.find('form').on('submit', submit);\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tCategories.create = function (payload) {\r\n\t\tsocket.emit('admin.categories.create', payload, function (err, data) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tapp.alert({\r\n\t\t\t\talert_id: 'category_created',\r\n\t\t\t\ttitle: '[[admin/manage/categories:alert.created]]',\r\n\t\t\t\tmessage: '[[admin/manage/categories:alert.create-success]]',\r\n\t\t\t\ttype: 'success',\r\n\t\t\t\ttimeout: 2000,\r\n\t\t\t});\r\n\r\n\t\t\tajaxify.go('admin/manage/categories/' + data.cid);\r\n\t\t});\r\n\t};\r\n\r\n\tCategories.render = function (categories) {\r\n\t\tvar container = $('.categories');\r\n\r\n\t\tif (!categories || !categories.length) {\r\n\t\t\ttranslator.translate('[[admin/manage/categories:alert.none-active]]', function (text) {\r\n\t\t\t\t$('<div></div>')\r\n\t\t\t\t\t.addClass('alert alert-info text-center')\r\n\t\t\t\t\t.text(text)\r\n\t\t\t\t\t.appendTo(container);\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tsortables = {};\r\n\t\t\trenderList(categories, container, 0);\r\n\t\t}\r\n\t};\r\n\r\n\tCategories.toggle = function (cids, disabled) {\r\n\t\tvar payload = {};\r\n\r\n\t\tcids.forEach(function (cid) {\r\n\t\t\tpayload[cid] = {\r\n\t\t\t\tdisabled: disabled ? 1 : 0,\r\n\t\t\t};\r\n\t\t});\r\n\r\n\t\tsocket.emit('admin.categories.update', payload, function (err) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\t\t\tajaxify.refresh();\r\n\t\t});\r\n\t};\r\n\r\n\tfunction itemDidAdd(e) {\r\n\t\tnewCategoryId = e.to.dataset.cid;\r\n\t}\r\n\r\n\tfunction itemDragDidEnd(e) {\r\n\t\tvar isCategoryUpdate = parseInt(newCategoryId, 10) !== -1;\r\n\r\n\t\t// Update needed?\r\n\t\tif ((e.newIndex != null && parseInt(e.oldIndex, 10) !== parseInt(e.newIndex, 10)) || isCategoryUpdate) {\r\n\t\t\tvar parentCategory = isCategoryUpdate ? sortables[newCategoryId] : sortables[e.from.dataset.cid];\r\n\t\t\tvar modified = {};\r\n\t\t\tvar i = 0;\r\n\t\t\tvar list = parentCategory.toArray();\r\n\t\t\tvar len = list.length;\r\n\r\n\t\t\tfor (i; i < len; i += 1) {\r\n\t\t\t\tmodified[list[i]] = {\r\n\t\t\t\t\torder: (i + 1),\r\n\t\t\t\t};\r\n\t\t\t}\r\n\r\n\t\t\tif (isCategoryUpdate) {\r\n\t\t\t\tmodified[e.item.dataset.cid].parentCid = newCategoryId;\r\n\t\t\t}\r\n\r\n\t\t\tnewCategoryId = -1;\r\n\t\t\tsocket.emit('admin.categories.update', modified);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Render categories - recursively\r\n\t *\r\n\t * @param categories {array} categories tree\r\n\t * @param level {number} current sub-level of rendering\r\n\t * @param container {object} parent jquery element for the list\r\n\t * @param parentId {number} parent category identifier\r\n\t */\r\n\tfunction renderList(categories, container, parentId) {\r\n\t\t// Translate category names if needed\r\n\t\tvar count = 0;\r\n\t\tcategories.forEach(function (category, idx, parent) {\r\n\t\t\ttranslator.translate(category.name, function (translated) {\r\n\t\t\t\tif (category.name !== translated) {\r\n\t\t\t\t\tcategory.name = translated;\r\n\t\t\t\t}\r\n\t\t\t\tcount += 1;\r\n\r\n\t\t\t\tif (count === parent.length) {\r\n\t\t\t\t\tcontinueRender();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tif (!categories.length) {\r\n\t\t\tcontinueRender();\r\n\t\t}\r\n\r\n\t\tfunction continueRender() {\r\n\t\t\tBenchpress.parse('admin/partials/categories/category-rows', {\r\n\t\t\t\tcid: parentId,\r\n\t\t\t\tcategories: categories,\r\n\t\t\t}, function (html) {\r\n\t\t\t\ttranslator.translate(html, function (html) {\r\n\t\t\t\t\tcontainer.append(html);\r\n\r\n\t\t\t\t\t// Handle and children categories in this level have\r\n\t\t\t\t\tfor (var x = 0, numCategories = categories.length; x < numCategories; x += 1) {\r\n\t\t\t\t\t\trenderList(categories[x].children, $('li[data-cid=\"' + categories[x].cid + '\"]'), categories[x].cid);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Make list sortable\r\n\t\t\t\t\tsortables[parentId] = Sortable.create($('ul[data-cid=\"' + parentId + '\"]')[0], {\r\n\t\t\t\t\t\tgroup: 'cross-categories',\r\n\t\t\t\t\t\tanimation: 150,\r\n\t\t\t\t\t\thandle: '.icon',\r\n\t\t\t\t\t\tdataIdAttr: 'data-cid',\r\n\t\t\t\t\t\tghostClass: 'placeholder',\r\n\t\t\t\t\t\tonAdd: itemDidAdd,\r\n\t\t\t\t\t\tonEnd: itemDragDidEnd,\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\treturn Categories;\r\n});\r\n"]}