{"version":3,"sources":["public/src/admin/settings/email.js"],"names":["define","ace","module","emailEditor","init","configureEmailTester","configureEmailEditor","handleDigestHourChange","handleSmtpServiceChange","$","window","on","socket","emit","change","off","template","val","err","app","alertError","message","alertSuccess","updateEmailEditor","edit","$blockScrolling","Infinity","setTheme","getSession","setMode","emailPath","original","ajaxify","data","emails","forEach","email","path","newEmail","getValue","setValue","text","attr","hour","parseInt","isNaN","now","Date","toString","setHours","getTime","setDate","getDate","isCustom"],"mappings":"AAAA,aAGAA,OAAO,wBAAyB,UAAW,kBAAmB,SAAUC,GACvE,IAAIC,KACJ,IAAIC,EAEJD,EAAOE,KAAO,WACbC,IACAC,IACAC,IACAC,IAEAC,EAAEC,QAAQC,GAAG,yDAA0DJ,GACvEE,EAAEC,QAAQC,GAAG,6BAA8B,WAC1CC,OAAOC,KAAK,4BAEbJ,EAAE,sCAAsCK,OAAON,IAGhD,SAASH,IACRI,EAAE,oCAAoCM,IAAI,SAASJ,GAAG,QAAS,WAC9DC,OAAOC,KAAK,oBAAsBG,SAAUP,EAAE,eAAeQ,OAAS,SAAUC,GAC/E,GAAIA,EAAK,CACR,OAAOC,IAAIC,WAAWF,EAAIG,SAE3BF,IAAIG,aAAa,qBAElB,OAAO,QAIT,SAAShB,IACRG,EAAE,0BAA0BE,GAAG,SAAUY,GAEzCpB,EAAcF,EAAIuB,KAAK,gBACvBrB,EAAYsB,gBAAkBC,SAC9BvB,EAAYwB,SAAS,sBACrBxB,EAAYyB,aAAaC,QAAQ,iBAEjC1B,EAAYQ,GAAG,SAAU,WACxB,IAAImB,EAAYrB,EAAE,0BAA0BQ,MAC5C,IAAIc,EACJC,QAAQC,KAAKC,OAAOC,QAAQ,SAAUC,GACrC,GAAIA,EAAMC,OAASP,EAAW,CAC7BC,EAAWK,EAAML,YAGnB,IAAIO,EAAWnC,EAAYoC,WAC3B9B,EAAE,wBAAwBQ,IAAIqB,IAAaP,EAAWO,EAAW,MAGlE7B,EAAE,sCAAsCM,IAAI,SAASJ,GAAG,QAAS,WAChEqB,QAAQC,KAAKC,OAAOC,QAAQ,SAAUC,GACrC,GAAIA,EAAMC,OAAS5B,EAAE,0BAA0BQ,MAAO,CACrDd,EAAYyB,aAAaY,SAASJ,EAAML,UACxCtB,EAAE,wBAAwBQ,IAAI,SAKjCM,IAGD,SAASA,IACRS,QAAQC,KAAKC,OAAOC,QAAQ,SAAUC,GACrC,GAAIA,EAAMC,OAAS5B,EAAE,0BAA0BQ,MAAO,CACrDd,EAAYyB,aAAaY,SAASJ,EAAMK,MACxChC,EAAE,wBACAQ,IAAImB,EAAMK,OAASL,EAAML,SAAWK,EAAMK,KAAO,IACjDC,KAAK,aAAc,gBAAkBN,EAAMC,SAKhD,SAAS9B,IACR,IAAIoC,EAAOC,SAASnC,EAAE,eAAeQ,MAAO,IAE5C,GAAI4B,MAAMF,GAAO,CAChBA,EAAO,QACD,GAAIA,EAAO,IAAMA,EAAO,EAAG,CACjCA,EAAO,EAGR/B,OAAOC,KAAK,wBAA0B,SAAUK,EAAK4B,GACpD,GAAI5B,EAAK,CACR,OAAOC,IAAIC,WAAWF,EAAIG,SAG3ByB,EAAM,IAAIC,KAAKD,GAEfrC,EAAE,eAAegC,KAAKK,EAAIE,YAE1BF,EAAIG,SAASL,SAASD,EAAM,IAAK,EAAG,EAAG,GAGvC,GAAIG,EAAII,UAAYH,KAAKD,MAAO,CAC/BA,EAAIK,QAAQL,EAAIM,UAAY,GAG7B3C,EAAE,mBAAmBgC,KAAKK,EAAIE,cAIhC,SAASxC,IACR,IAAI6C,EAAW5C,EAAE,sCAAsCQ,QAAU,qBACjER,EAAE,6CAA6C4C,EAAW,YAAc,WAAWA,GAGpF,OAAOnD","file":"public/src/admin/settings/email.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('admin/settings/email', ['ace/ace', 'admin/settings'], function (ace) {\r\n\tvar module = {};\r\n\tvar emailEditor;\r\n\r\n\tmodule.init = function () {\r\n\t\tconfigureEmailTester();\r\n\t\tconfigureEmailEditor();\r\n\t\thandleDigestHourChange();\r\n\t\thandleSmtpServiceChange();\r\n\r\n\t\t$(window).on('action:admin.settingsLoaded action:admin.settingsSaved', handleDigestHourChange);\r\n\t\t$(window).on('action:admin.settingsSaved', function () {\r\n\t\t\tsocket.emit('admin.user.restartJobs');\r\n\t\t});\r\n\t\t$('[id=\"email:smtpTransport:service\"]').change(handleSmtpServiceChange);\r\n\t};\r\n\r\n\tfunction configureEmailTester() {\r\n\t\t$('button[data-action=\"email.test\"]').off('click').on('click', function () {\r\n\t\t\tsocket.emit('admin.email.test', { template: $('#test-email').val() }, function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\t\t\t\tapp.alertSuccess('Test Email Sent');\r\n\t\t\t});\r\n\t\t\treturn false;\r\n\t\t});\r\n\t}\r\n\r\n\tfunction configureEmailEditor() {\r\n\t\t$('#email-editor-selector').on('change', updateEmailEditor);\r\n\r\n\t\temailEditor = ace.edit('email-editor');\r\n\t\temailEditor.$blockScrolling = Infinity;\r\n\t\temailEditor.setTheme('ace/theme/twilight');\r\n\t\temailEditor.getSession().setMode('ace/mode/html');\r\n\r\n\t\temailEditor.on('change', function () {\r\n\t\t\tvar emailPath = $('#email-editor-selector').val();\r\n\t\t\tvar original;\r\n\t\t\tajaxify.data.emails.forEach(function (email) {\r\n\t\t\t\tif (email.path === emailPath) {\r\n\t\t\t\t\toriginal = email.original;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tvar newEmail = emailEditor.getValue();\r\n\t\t\t$('#email-editor-holder').val(newEmail !== original ? newEmail : '');\r\n\t\t});\r\n\r\n\t\t$('button[data-action=\"email.revert\"]').off('click').on('click', function () {\r\n\t\t\tajaxify.data.emails.forEach(function (email) {\r\n\t\t\t\tif (email.path === $('#email-editor-selector').val()) {\r\n\t\t\t\t\temailEditor.getSession().setValue(email.original);\r\n\t\t\t\t\t$('#email-editor-holder').val('');\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tupdateEmailEditor();\r\n\t}\r\n\r\n\tfunction updateEmailEditor() {\r\n\t\tajaxify.data.emails.forEach(function (email) {\r\n\t\t\tif (email.path === $('#email-editor-selector').val()) {\r\n\t\t\t\temailEditor.getSession().setValue(email.text);\r\n\t\t\t\t$('#email-editor-holder')\r\n\t\t\t\t\t.val(email.text !== email.original ? email.text : '')\r\n\t\t\t\t\t.attr('data-field', 'email:custom:' + email.path);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction handleDigestHourChange() {\r\n\t\tvar hour = parseInt($('#digestHour').val(), 10);\r\n\r\n\t\tif (isNaN(hour)) {\r\n\t\t\thour = 17;\r\n\t\t} else if (hour > 23 || hour < 0) {\r\n\t\t\thour = 0;\r\n\t\t}\r\n\r\n\t\tsocket.emit('meta.getServerTime', {}, function (err, now) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tnow = new Date(now);\r\n\r\n\t\t\t$('#serverTime').text(now.toString());\r\n\r\n\t\t\tnow.setHours(parseInt(hour, 10), 0, 0, 0);\r\n\r\n\t\t\t// If adjusted time is in the past, move to next day\r\n\t\t\tif (now.getTime() < Date.now()) {\r\n\t\t\t\tnow.setDate(now.getDate() + 1);\r\n\t\t\t}\r\n\r\n\t\t\t$('#nextDigestTime').text(now.toString());\r\n\t\t});\r\n\t}\r\n\r\n\tfunction handleSmtpServiceChange() {\r\n\t\tvar isCustom = $('[id=\"email:smtpTransport:service\"]').val() === 'nodebb-custom-smtp';\r\n\t\t$('[id=\"email:smtpTransport:custom-service\"]')[isCustom ? 'slideDown' : 'slideUp'](isCustom);\r\n\t}\r\n\r\n\treturn module;\r\n});\r\n"]}