{"version":3,"sources":["public/src/client/category.js"],"names":["define","infinitescroll","share","navigator","categoryTools","recent","sort","components","translator","topicSelect","handleBack","Category","$","window","on","ev","data","String","url","startsWith","disable","removeListeners","init","cid","ajaxify","app","enterRoom","addShareHandlers","name","watchForNewPosts","handleSort","slug","enableInfiniteLoadingOrPagination","after","cb","loadTopicsAfter","handleScrollToTopicIndex","handleIgnoreWatch","trigger","topics","parts","location","pathname","split","topicIndex","length","utils","isNumber","Math","max","parseInt","search","indexOf","scrollToElement","$this","this","command","attr","socket","emit","err","alertError","message","toggleClass","alertSuccess","toTop","scrollTop","toBottom","count","scrollBottom","navigatorCallback","topIndex","bottomIndex","config","usePagination","topic_count","loadMoreTopics","direction","children","afterEl","last","first","callback","get","params","loadMore","query","categoryTopicSort","done","onTopicsLoaded","removeAlreadyAddedTopics","filter","topic","tid","showSelect","privileges","editable","before","parseAndTranslate","html","removeClass","remove","insertAfter","height","document","insertBefore","append","getSelectedTids","removeExtra","topicsPerPage","find","timeago","createUserTooltips","makeNumbersHumanReadable"],"mappings":"AAAA,aAGAA,OAAO,kBACN,uBACA,QACA,YACA,uBACA,eACA,OACA,aACA,aACA,cACA,cACE,SAAUC,EAAgBC,EAAOC,EAAWC,EAAeC,EAAQC,EAAMC,EAAYC,EAAYC,EAAaC,GAChH,IAAIC,KAEJC,EAAEC,QAAQC,GAAG,uBAAwB,SAAUC,EAAIC,GAClD,IAAKC,OAAOD,EAAKE,KAAKC,WAAW,aAAc,CAC9ChB,EAAUiB,UAEVC,OAIF,SAASA,IACRjB,EAAciB,kBACdhB,EAAOgB,kBAGRV,EAASW,KAAO,WACf,IAAIC,EAAMC,QAAQR,KAAKO,IAEvBE,IAAIC,UAAU,YAAcH,GAE5BrB,EAAMyB,iBAAiBH,QAAQR,KAAKY,MAEpCxB,EAAckB,KAAKC,GACnBlB,EAAOwB,mBAEPvB,EAAKwB,WAAW,oBAAqB,uBAAwB,YAAcN,QAAQR,KAAKe,MAExFC,IAEAtB,EAAWY,KAAK,SAAUW,EAAOC,GAChCC,EAAgBF,EAAO,EAAGC,KAG3BE,IAEAC,EAAkBd,GAElBX,EAAEC,QAAQyB,QAAQ,wBAA0BC,OAAQf,QAAQR,KAAKuB,SACjE3B,EAAEC,QAAQyB,QAAQ,0BAA4Bf,IAAKC,QAAQR,KAAKO,OAGjE,SAASa,IACR,IAAII,EAAQ3B,OAAO4B,SAASC,SAASC,MAAM,KAC3C,IAAIC,EAAaJ,EAAMA,EAAMK,OAAS,GACtC,GAAID,GAAcE,MAAMC,SAASH,GAAa,CAC7CA,EAAaI,KAAKC,IAAI,EAAGC,SAASN,EAAY,IAAM,GACpD,GAAIA,GAAc/B,OAAO4B,SAASU,OAAOC,QAAQ,YAAc,EAAG,CACjEjD,EAAUkD,gBAAgBzC,EAAE,4CAA8CgC,EAAa,MAAO,KAAM,KAKvG,SAASP,EAAkBd,GAC1BX,EAAE,oEAAoEE,GAAG,QAAS,WACjF,IAAIwC,EAAQ1C,EAAE2C,MACd,IAAIC,EAAUF,EAAMG,KAAK,eAAiB,oBAAsB,QAAU,SAE1EC,OAAOC,KAAK,cAAgBH,EAASjC,EAAK,SAAUqC,GACnD,GAAIA,EAAK,CACR,OAAOnC,IAAIoC,WAAWD,EAAIE,SAG3BlD,EAAE,wCAAwCmD,YAAY,SAAUP,IAAY,SAC5E5C,EAAE,yCAAyCmD,YAAY,WAAYP,IAAY,SAE/E5C,EAAE,wCAAwCmD,YAAY,SAAUP,IAAY,UAC5E5C,EAAE,yCAAyCmD,YAAY,WAAYP,IAAY,UAE/E/B,IAAIuC,aAAa,cAAgBR,EAAU,kBAK9C7C,EAASsD,MAAQ,WAChB9D,EAAU+D,UAAU,IAGrBvD,EAASwD,SAAW,WACnBT,OAAOC,KAAK,2BAA4BnC,QAAQR,KAAKO,IAAK,SAAUqC,EAAKQ,GACxE,GAAIR,EAAK,CACR,OAAOnC,IAAIoC,WAAWD,EAAIE,SAG3B3D,EAAUkE,aAAaD,EAAQ,MAIjCzD,EAAS2D,kBAAoB,SAAUC,EAAUC,GAChD,OAAOA,GAGR,SAASxC,IACR,IAAKyC,OAAOC,cAAe,CAC1BvE,EAAUmB,KAAK,+BAAgCE,QAAQR,KAAK2D,YAAahE,EAASsD,MAAOtD,EAASwD,SAAUxD,EAAS2D,mBACrHrE,EAAeqB,KAAKV,EAAE,0BAA2BD,EAASiE,oBACpD,CACNzE,EAAUiB,WAIZT,EAASiE,eAAiB,SAAUC,GACnC,IAAKjE,EAAE,0BAA0BiC,SAAWjC,EAAE,0BAA0BkE,WAAWjC,OAAQ,CAC1F,OAGD,IAAIN,EAAS3B,EAAE,gCACf,IAAImE,EAAUF,EAAY,EAAItC,EAAOyC,OAASzC,EAAO0C,QACrD,IAAIhD,GAASiB,SAAS6B,EAAQtB,KAAK,cAAe,KAAO,IAAMoB,EAAY,EAAI,EAAI,GAEnF1C,EAAgBF,EAAO4C,IAGxB,SAAS1C,EAAgBF,EAAO4C,EAAWK,GAC1CA,EAAWA,GAAY,aACvB,IAAKpC,MAAMC,SAASd,IAAWA,IAAU,GAAK1B,EAAW4E,IAAI,iBAAkB,QAAS,GAAGtC,OAAS,CACnG,OAAOqC,IAGRtE,EAAEC,QAAQyB,QAAQ,2BAClB,IAAI8C,EAAStC,MAAMsC,SACnBnF,EAAeoF,SAAS,uBACvB9D,IAAKC,QAAQR,KAAKO,IAClBU,MAAOA,EACP4C,UAAWA,EACXS,MAAOF,EACPG,kBAAmBd,OAAOc,mBACxB,SAAUvE,EAAMwE,GAClB,GAAIxE,EAAKuB,QAAUvB,EAAKuB,OAAOM,OAAQ,CACtClC,EAAS8E,eAAezE,EAAM6D,EAAWW,OACnC,CACNA,IAGD5E,EAAEC,QAAQyB,QAAQ,0BAClB4C,MAKFvE,EAAS8E,eAAiB,SAAUzE,EAAM6D,EAAWK,GACpD,IAAKlE,IAASA,EAAKuB,OAAOM,OAAQ,CACjC,OAAOqC,IAGR,SAASQ,EAAyBnD,GACjC,OAAOA,EAAOoD,OAAO,SAAUC,GAC9B,OAAOrF,EAAW4E,IAAI,iBAAkB,MAAOS,EAAMC,KAAKhD,SAAW,IAIvE7B,EAAKuB,OAASmD,EAAyB1E,EAAKuB,QAC5C,IAAKvB,EAAKuB,OAAOM,OAAQ,CACxB,OAAOqC,IAGRlE,EAAK8E,WAAa9E,EAAK+E,WAAWC,SAElC,IAAI/D,EACJ,IAAIgE,EACJ,IAAI1D,EAAS3B,EAAE,gCAEf,GAAIiE,EAAY,GAAKtC,EAAOM,OAAQ,CACnCZ,EAAQM,EAAOyC,YACT,GAAIH,EAAY,GAAKtC,EAAOM,OAAQ,CAC1CoD,EAAS1D,EAAO0C,QAGjBxD,IAAIyE,kBAAkB,WAAY,SAAUlF,EAAM,SAAUmF,GAC3DvF,EAAE,0BAA0BwF,YAAY,UACxCxF,EAAE,qBAAqBwF,YAAY,UAEnCxF,EAAE,uBAAuByF,SAEzB,GAAIpE,EAAO,CACVkE,EAAKG,YAAYrE,QACX,GAAIgE,EAAQ,CAClB,IAAIM,EAAS3F,EAAE4F,UAAUD,SACzB,IAAIrC,EAAYtD,EAAEC,QAAQqD,YAE1BiC,EAAKM,aAAaR,GAElBrF,EAAEC,QAAQqD,UAAUA,GAAatD,EAAE4F,UAAUD,SAAWA,QAClD,CACN3F,EAAE,0BAA0B8F,OAAOP,GAGpC,IAAK1F,EAAYkG,kBAAkB9D,OAAQ,CAC1C5C,EAAe2G,YAAYhG,EAAE,gCAAiCiE,EAAWJ,OAAOoC,cAAgB,GAGjGV,EAAKW,KAAK,YAAYC,UACtBtF,IAAIuF,qBACJlE,MAAMmE,yBAAyBd,EAAKW,KAAK,2BAEzClG,EAAEC,QAAQyB,QAAQ,wBAA0BC,OAAQvB,EAAKuB,SAEzD2C,OAIF,OAAOvE","file":"public/src/client/category.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('forum/category', [\r\n\t'forum/infinitescroll',\r\n\t'share',\r\n\t'navigator',\r\n\t'forum/category/tools',\r\n\t'forum/recent',\r\n\t'sort',\r\n\t'components',\r\n\t'translator',\r\n\t'topicSelect',\r\n\t'handleBack',\r\n], function (infinitescroll, share, navigator, categoryTools, recent, sort, components, translator, topicSelect, handleBack) {\r\n\tvar Category = {};\r\n\r\n\t$(window).on('action:ajaxify.start', function (ev, data) {\r\n\t\tif (!String(data.url).startsWith('category/')) {\r\n\t\t\tnavigator.disable();\r\n\r\n\t\t\tremoveListeners();\r\n\t\t}\r\n\t});\r\n\r\n\tfunction removeListeners() {\r\n\t\tcategoryTools.removeListeners();\r\n\t\trecent.removeListeners();\r\n\t}\r\n\r\n\tCategory.init = function () {\r\n\t\tvar\tcid = ajaxify.data.cid;\r\n\r\n\t\tapp.enterRoom('category_' + cid);\r\n\r\n\t\tshare.addShareHandlers(ajaxify.data.name);\r\n\r\n\t\tcategoryTools.init(cid);\r\n\t\trecent.watchForNewPosts();\r\n\r\n\t\tsort.handleSort('categoryTopicSort', 'user.setCategorySort', 'category/' + ajaxify.data.slug);\r\n\r\n\t\tenableInfiniteLoadingOrPagination();\r\n\r\n\t\thandleBack.init(function (after, cb) {\r\n\t\t\tloadTopicsAfter(after, 1, cb);\r\n\t\t});\r\n\r\n\t\thandleScrollToTopicIndex();\r\n\r\n\t\thandleIgnoreWatch(cid);\r\n\r\n\t\t$(window).trigger('action:topics.loaded', { topics: ajaxify.data.topics });\r\n\t\t$(window).trigger('action:category.loaded', { cid: ajaxify.data.cid });\r\n\t};\r\n\r\n\tfunction handleScrollToTopicIndex() {\r\n\t\tvar parts = window.location.pathname.split('/');\r\n\t\tvar topicIndex = parts[parts.length - 1];\r\n\t\tif (topicIndex && utils.isNumber(topicIndex)) {\r\n\t\t\ttopicIndex = Math.max(0, parseInt(topicIndex, 10) - 1);\r\n\t\t\tif (topicIndex && window.location.search.indexOf('page=') === -1) {\r\n\t\t\t\tnavigator.scrollToElement($('[component=\"category/topic\"][data-index=\"' + topicIndex + '\"]'), true, 0);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction handleIgnoreWatch(cid) {\r\n\t\t$('[component=\"category/watching\"], [component=\"category/ignoring\"]').on('click', function () {\r\n\t\t\tvar $this = $(this);\r\n\t\t\tvar command = $this.attr('component') === 'category/watching' ? 'watch' : 'ignore';\r\n\r\n\t\t\tsocket.emit('categories.' + command, cid, function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$('[component=\"category/watching/menu\"]').toggleClass('hidden', command !== 'watch');\r\n\t\t\t\t$('[component=\"category/watching/check\"]').toggleClass('fa-check', command === 'watch');\r\n\r\n\t\t\t\t$('[component=\"category/ignoring/menu\"]').toggleClass('hidden', command !== 'ignore');\r\n\t\t\t\t$('[component=\"category/ignoring/check\"]').toggleClass('fa-check', command === 'ignore');\r\n\r\n\t\t\t\tapp.alertSuccess('[[category:' + command + '.message]]');\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tCategory.toTop = function () {\r\n\t\tnavigator.scrollTop(0);\r\n\t};\r\n\r\n\tCategory.toBottom = function () {\r\n\t\tsocket.emit('categories.getTopicCount', ajaxify.data.cid, function (err, count) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tnavigator.scrollBottom(count - 1);\r\n\t\t});\r\n\t};\r\n\r\n\tCategory.navigatorCallback = function (topIndex, bottomIndex) {\r\n\t\treturn bottomIndex;\r\n\t};\r\n\r\n\tfunction enableInfiniteLoadingOrPagination() {\r\n\t\tif (!config.usePagination) {\r\n\t\t\tnavigator.init('[component=\"category/topic\"]', ajaxify.data.topic_count, Category.toTop, Category.toBottom, Category.navigatorCallback);\r\n\t\t\tinfinitescroll.init($('[component=\"category\"]'), Category.loadMoreTopics);\r\n\t\t} else {\r\n\t\t\tnavigator.disable();\r\n\t\t}\r\n\t}\r\n\r\n\tCategory.loadMoreTopics = function (direction) {\r\n\t\tif (!$('[component=\"category\"]').length || !$('[component=\"category\"]').children().length) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar topics = $('[component=\"category/topic\"]');\r\n\t\tvar afterEl = direction > 0 ? topics.last() : topics.first();\r\n\t\tvar after = (parseInt(afterEl.attr('data-index'), 10) || 0) + (direction > 0 ? 1 : 0);\r\n\r\n\t\tloadTopicsAfter(after, direction);\r\n\t};\r\n\r\n\tfunction loadTopicsAfter(after, direction, callback) {\r\n\t\tcallback = callback || function () {};\r\n\t\tif (!utils.isNumber(after) || (after === 0 && components.get('category/topic', 'index', 0).length)) {\r\n\t\t\treturn callback();\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:category.loading');\r\n\t\tvar params = utils.params();\r\n\t\tinfinitescroll.loadMore('categories.loadMore', {\r\n\t\t\tcid: ajaxify.data.cid,\r\n\t\t\tafter: after,\r\n\t\t\tdirection: direction,\r\n\t\t\tquery: params,\r\n\t\t\tcategoryTopicSort: config.categoryTopicSort,\r\n\t\t}, function (data, done) {\r\n\t\t\tif (data.topics && data.topics.length) {\r\n\t\t\t\tCategory.onTopicsLoaded(data, direction, done);\r\n\t\t\t} else {\r\n\t\t\t\tdone();\r\n\t\t\t}\r\n\r\n\t\t\t$(window).trigger('action:category.loaded');\r\n\t\t\tcallback();\r\n\t\t});\r\n\t}\r\n\r\n\r\n\tCategory.onTopicsLoaded = function (data, direction, callback) {\r\n\t\tif (!data || !data.topics.length) {\r\n\t\t\treturn callback();\r\n\t\t}\r\n\r\n\t\tfunction removeAlreadyAddedTopics(topics) {\r\n\t\t\treturn topics.filter(function (topic) {\r\n\t\t\t\treturn components.get('category/topic', 'tid', topic.tid).length === 0;\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tdata.topics = removeAlreadyAddedTopics(data.topics);\r\n\t\tif (!data.topics.length) {\r\n\t\t\treturn callback();\r\n\t\t}\r\n\r\n\t\tdata.showSelect = data.privileges.editable;\r\n\r\n\t\tvar after;\r\n\t\tvar before;\r\n\t\tvar topics = $('[component=\"category/topic\"]');\r\n\r\n\t\tif (direction > 0 && topics.length) {\r\n\t\t\tafter = topics.last();\r\n\t\t} else if (direction < 0 && topics.length) {\r\n\t\t\tbefore = topics.first();\r\n\t\t}\r\n\r\n\t\tapp.parseAndTranslate('category', 'topics', data, function (html) {\r\n\t\t\t$('[component=\"category\"]').removeClass('hidden');\r\n\t\t\t$('.category-sidebar').removeClass('hidden');\r\n\r\n\t\t\t$('#category-no-topics').remove();\r\n\r\n\t\t\tif (after) {\r\n\t\t\t\thtml.insertAfter(after);\r\n\t\t\t} else if (before) {\r\n\t\t\t\tvar height = $(document).height();\r\n\t\t\t\tvar scrollTop = $(window).scrollTop();\r\n\r\n\t\t\t\thtml.insertBefore(before);\r\n\r\n\t\t\t\t$(window).scrollTop(scrollTop + ($(document).height() - height));\r\n\t\t\t} else {\r\n\t\t\t\t$('[component=\"category\"]').append(html);\r\n\t\t\t}\r\n\r\n\t\t\tif (!topicSelect.getSelectedTids().length) {\r\n\t\t\t\tinfinitescroll.removeExtra($('[component=\"category/topic\"]'), direction, config.topicsPerPage * 3);\r\n\t\t\t}\r\n\r\n\t\t\thtml.find('.timeago').timeago();\r\n\t\t\tapp.createUserTooltips();\r\n\t\t\tutils.makeNumbersHumanReadable(html.find('.human-readable-number'));\r\n\r\n\t\t\t$(window).trigger('action:topics.loaded', { topics: data.topics });\r\n\r\n\t\t\tcallback();\r\n\t\t});\r\n\t};\r\n\r\n\treturn Category;\r\n});\r\n"]}