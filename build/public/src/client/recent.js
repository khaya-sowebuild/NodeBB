"use strict";define("forum/recent",["forum/infinitescroll","components","handleBack"],function(e,t,a){var i={};var n=0;var o=0;$(window).on("action:ajaxify.start",function(e,t){if(ajaxify.currentPage!==t.url){i.removeListeners()}});i.init=function(){app.enterRoom("recent_topics");i.watchForNewPosts();i.handleCategorySelection();a.init(function(e,t){s(e,1,t)});$("#new-topics-alert").on("click",function(){$(this).addClass("hide")});if(!config.usePagination){e.init(i.loadMoreTopics)}$(window).trigger("action:topics.loaded",{topics:ajaxify.data.topics})};i.watchForNewPosts=function(){o=0;n=0;i.removeListeners();socket.on("event:new_topic",r);socket.on("event:new_post",c)};function r(e){if(ajaxify.data.selectedCids&&ajaxify.data.selectedCids.indexOf(parseInt(e.cid,10))===-1){return}if(ajaxify.data.selectedFilter&&ajaxify.data.selectedFilter.filter==="watched"){return}if(ajaxify.data.template.category&&parseInt(ajaxify.data.cid,10)!==parseInt(e.cid,10)){return}n+=1;i.updateAlertText()}function c(e){function t(){o+=1;i.updateAlertText()}var a=e.posts[0];if(!a||!a.topic){return}if(parseInt(a.topic.mainPid,10)===parseInt(a.pid,10)){return}if(ajaxify.data.selectedCids&&ajaxify.data.selectedCids.indexOf(parseInt(a.topic.cid,10))===-1){return}if(ajaxify.data.selectedFilter&&ajaxify.data.selectedFilter.filter==="new"){return}if(ajaxify.data.template.category&&parseInt(ajaxify.data.cid,10)!==parseInt(a.topic.cid,10)){return}if(ajaxify.data.selectedFilter&&ajaxify.data.selectedFilter.filter==="watched"){socket.emit("topics.isFollowed",a.tid,function(e,a){if(e){app.alertError(e.message)}if(a){t()}});return}t()}i.handleCategorySelection=function(){function e(){var e=[];$('[component="category/list"] [data-cid]').each(function(t,a){if($(a).find("i.fa-check").length){e.push(parseInt($(a).attr("data-cid"),10))}});e.sort(function(e,t){return e-t});return e}$('[component="category/dropdown"]').on("hidden.bs.dropdown",function(){var t=e();var a=ajaxify.data.selectedCids.length!==t.length;ajaxify.data.selectedCids.forEach(function(e,i){if(e!==t[i]){a=true}});if(a){var i=window.location.pathname;var n=utils.params();if(t.length){n.cid=t;i+="?"+decodeURIComponent($.param(n))}ajaxify.go(i)}});$('[component="category/list"]').on("click","[data-cid]",function(t){function a(e,t){$('[component="category/list"] [data-parent-cid="'+e+'"] [component="category/select/icon"]').toggleClass("fa-check",t);$('[component="category/list"] [data-parent-cid="'+e+'"]').each(function(e,i){a($(i).attr("data-cid"),t)})}var i=$(this);var n=$(this).attr("data-cid");if(t.ctrlKey){a(n,!i.find('[component="category/select/icon"]').hasClass("fa-check"))}i.find('[component="category/select/icon"]').toggleClass("fa-check");$('[component="category/list"] li').first().find("i").toggleClass("fa-check",!e().length);return false})};i.removeListeners=function(){socket.removeListener("event:new_topic",r);socket.removeListener("event:new_post",c)};i.updateAlertText=function(){var e="";if(n===0){if(o===1){e="[[recent:there-is-a-new-post]]"}else if(o>1){e="[[recent:there-are-new-posts, "+o+"]]"}}else if(n===1){if(o===0){e="[[recent:there-is-a-new-topic]]"}else if(o===1){e="[[recent:there-is-a-new-topic-and-a-new-post]]"}else if(o>1){e="[[recent:there-is-a-new-topic-and-new-posts, "+o+"]]"}}else if(n>1){if(o===0){e="[[recent:there-are-new-topics, "+n+"]]"}else if(o===1){e="[[recent:there-are-new-topics-and-a-new-post, "+n+"]]"}else if(o>1){e="[[recent:there-are-new-topics-and-new-posts, "+n+", "+o+"]]"}}e+=" [[recent:click-here-to-reload]]";$("#new-topics-alert").translateText(e).removeClass("hide").fadeIn("slow");$("#category-no-topics").addClass("hide")};i.loadMoreTopics=function(e){if(!$('[component="category"]').length){return}var t=$('[component="category/topic"]');var a=e>0?t.last():t.first();var i=(parseInt(a.attr("data-index"),10)||0)+(e>0?1:0);s(i,e)};function s(t,a,n){n=n||function(){};e.loadMore("topics.loadMoreRecentTopics",{after:t,direction:a,count:config.topicsPerPage,cid:utils.params().cid,filter:ajaxify.data.selectedFilter.filter,set:$('[component="category"]').attr("data-set")?$('[component="category"]').attr("data-set"):"topics:recent"},function(e,t){if(e.topics&&e.topics.length){i.onTopicsLoaded("recent",e.topics,false,a,t)}else{t()}$('[component="category"]').attr("data-nextstart",e.nextStart);n()})}i.onTopicsLoaded=function(e,a,i,n,o){a=a.filter(function(e){return!t.get("category/topic","tid",e.tid).length});if(!a.length){return o()}var r;var c;var s=$('[component="category/topic"]');if(n>0&&a.length){r=s.last()}else if(n<0&&a.length){c=s.first()}app.parseAndTranslate(e,"topics",{topics:a,showSelect:i},function(e){$("#category-no-topics").remove();if(r&&r.length){e.insertAfter(r)}else if(c&&c.length){var t=$(document).height();var i=$(window).scrollTop();e.insertBefore(c);$(window).scrollTop(i+($(document).height()-t))}else{$('[component="category"]').append(e)}e.find(".timeago").timeago();app.createUserTooltips();utils.makeNumbersHumanReadable(e.find(".human-readable-number"));$(window).trigger("action:topics.loaded",{topics:a});o()})};return i});
//# sourceMappingURL=public/src/client/recent.js.map