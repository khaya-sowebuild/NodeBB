{"version":3,"sources":["public/src/client/search.js"],"names":["define","searchModule","autocomplete","storage","Search","init","searchQuery","$","attr","searchIn","on","updateFormItemVisiblity","val","highlightMatches","off","e","preventDefault","query","getSearchDataFromDOM","handleSavePreferences","enableAutoComplete","fillOutForm","form","searchData","in","term","matchWords","find","by","tagsinput","categories","searchChildren","is","hasTags","replies","repliesFilter","timeFilter","timeRange","sortBy","sortDirection","showAs","window","trigger","data","hide","indexOf","toggleClass","params","utils","getSearchPreferences","formData","merge","ajaxify","Array","isArray","forEach","prop","tag","searchDefaultSortBy","isTopic","isPost","parent","escapeHTML","regexStr","replace","trim","split","join","regex","RegExp","each","result","this","nested","after","length","push","append","html","match","p1","nestedEl","i","addClass","setItem","JSON","stringify","app","alertSuccess","removeItem","reset","userEl","confirmKeys","trimValue","user","siblings","tagEl"],"mappings":"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","file":"public/src/client/search.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('forum/search', ['search', 'autocomplete', 'storage'], function (searchModule, autocomplete, storage) {\r\n\tvar\tSearch = {};\r\n\r\n\tSearch.init = function () {\r\n\t\tvar searchQuery = $('#results').attr('data-search-query');\r\n\r\n\t\tvar searchIn = $('#search-in');\r\n\r\n\t\tsearchIn.on('change', function () {\r\n\t\t\tupdateFormItemVisiblity(searchIn.val());\r\n\t\t});\r\n\r\n\t\thighlightMatches(searchQuery);\r\n\r\n\t\t$('#advanced-search').off('submit').on('submit', function (e) {\r\n\t\t\te.preventDefault();\r\n\t\t\tsearchModule.query(getSearchDataFromDOM(), function () {\r\n\t\t\t\t$('#search-input').val('');\r\n\t\t\t});\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\thandleSavePreferences();\r\n\r\n\t\tenableAutoComplete();\r\n\r\n\t\tfillOutForm();\r\n\t};\r\n\r\n\tfunction getSearchDataFromDOM() {\r\n\t\tvar form = $('#advanced-search');\r\n\t\tvar searchData = {\r\n\t\t\tin: $('#search-in').val(),\r\n\t\t};\r\n\t\tsearchData.term = $('#search-input').val();\r\n\t\tif (searchData.in === 'posts' || searchData.in === 'titlesposts' || searchData.in === 'titles') {\r\n\t\t\tsearchData.matchWords = form.find('#match-words-filter').val();\r\n\t\t\tsearchData.by = form.find('#posted-by-user').tagsinput('items');\r\n\t\t\tsearchData.categories = form.find('#posted-in-categories').val();\r\n\t\t\tsearchData.searchChildren = form.find('#search-children').is(':checked');\r\n\t\t\tsearchData.hasTags = form.find('#has-tags').tagsinput('items');\r\n\t\t\tsearchData.replies = form.find('#reply-count').val();\r\n\t\t\tsearchData.repliesFilter = form.find('#reply-count-filter').val();\r\n\t\t\tsearchData.timeFilter = form.find('#post-time-filter').val();\r\n\t\t\tsearchData.timeRange = form.find('#post-time-range').val();\r\n\t\t\tsearchData.sortBy = form.find('#post-sort-by').val();\r\n\t\t\tsearchData.sortDirection = form.find('#post-sort-direction').val();\r\n\t\t\tsearchData.showAs = form.find('#show-as-topics').is(':checked') ? 'topics' : 'posts';\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:search.getSearchDataFromDOM', {\r\n\t\t\tform: form,\r\n\t\t\tdata: searchData,\r\n\t\t});\r\n\r\n\t\treturn searchData;\r\n\t}\r\n\r\n\tfunction updateFormItemVisiblity(searchIn) {\r\n\t\tvar hide = searchIn.indexOf('posts') === -1 && searchIn.indexOf('titles') === -1;\r\n\t\t$('.post-search-item').toggleClass('hide', hide);\r\n\t}\r\n\r\n\tfunction fillOutForm() {\r\n\t\tvar params = utils.params();\r\n\r\n\t\tvar searchData = searchModule.getSearchPreferences();\r\n\t\tvar formData = utils.merge(searchData, params);\r\n\r\n\t\tif (formData) {\r\n\t\t\tif (ajaxify.data.term) {\r\n\t\t\t\t$('#search-input').val(ajaxify.data.term);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.in) {\r\n\t\t\t\t$('#search-in').val(formData.in);\r\n\t\t\t\tupdateFormItemVisiblity(formData.in);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.matchWords) {\r\n\t\t\t\t$('#match-words-filter').val(formData.matchWords);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.by) {\r\n\t\t\t\tformData.by = Array.isArray(formData.by) ? formData.by : [formData.by];\r\n\t\t\t\tformData.by.forEach(function (by) {\r\n\t\t\t\t\t$('#posted-by-user').tagsinput('add', by);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.categories) {\r\n\t\t\t\t$('#posted-in-categories').val(formData.categories);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.searchChildren) {\r\n\t\t\t\t$('#search-children').prop('checked', true);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.hasTags) {\r\n\t\t\t\tformData.hasTags = Array.isArray(formData.hasTags) ? formData.hasTags : [formData.hasTags];\r\n\t\t\t\tformData.hasTags.forEach(function (tag) {\r\n\t\t\t\t\t$('#has-tags').tagsinput('add', tag);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.replies) {\r\n\t\t\t\t$('#reply-count').val(formData.replies);\r\n\t\t\t\t$('#reply-count-filter').val(formData.repliesFilter);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.timeRange) {\r\n\t\t\t\t$('#post-time-range').val(formData.timeRange);\r\n\t\t\t\t$('#post-time-filter').val(formData.timeFilter);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.sortBy || ajaxify.data.searchDefaultSortBy) {\r\n\t\t\t\t$('#post-sort-by').val(formData.sortBy || ajaxify.data.searchDefaultSortBy);\r\n\t\t\t\t$('#post-sort-direction').val(formData.sortDirection);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.showAs) {\r\n\t\t\t\tvar isTopic = formData.showAs === 'topics';\r\n\t\t\t\tvar isPost = formData.showAs === 'posts';\r\n\t\t\t\t$('#show-as-topics').prop('checked', isTopic).parent().toggleClass('active', isTopic);\r\n\t\t\t\t$('#show-as-posts').prop('checked', isPost).parent().toggleClass('active', isPost);\r\n\t\t\t}\r\n\r\n\t\t\t$(window).trigger('action:search.fillOutForm', {\r\n\t\t\t\tform: formData,\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tfunction highlightMatches(searchQuery) {\r\n\t\tif (!searchQuery) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tsearchQuery = utils.escapeHTML(searchQuery);\r\n\t\tvar regexStr = searchQuery.replace(/^\"/, '').replace(/\"$/, '').trim().split(' ').join('|');\r\n\t\tvar regex = new RegExp('(' + regexStr + ')', 'gi');\r\n\r\n\t\t$('.search-result-text p, .search-result-text h4').each(function () {\r\n\t\t\tvar result = $(this);\r\n\t\t\tvar nested = [];\r\n\r\n\t\t\tresult.find('*').each(function () {\r\n\t\t\t\t$(this).after('<!-- ' + nested.length + ' -->');\r\n\t\t\t\tnested.push($('<div />').append($(this)));\r\n\t\t\t});\r\n\r\n\t\t\tresult.html(result.html().replace(regex, function (match, p1) {\r\n\t\t\t\treturn '<strong>' + p1 + '</strong>';\r\n\t\t\t}));\r\n\r\n\t\t\tnested.forEach(function (nestedEl, i) {\r\n\t\t\t\tresult.html(result.html().replace('<!-- ' + i + ' -->', function () {\r\n\t\t\t\t\treturn nestedEl.html();\r\n\t\t\t\t}));\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\t$('.search-result-text').find('img:not(.not-responsive)').addClass('img-responsive');\r\n\t}\r\n\r\n\tfunction handleSavePreferences() {\r\n\t\t$('#save-preferences').on('click', function () {\r\n\t\t\tstorage.setItem('search-preferences', JSON.stringify(getSearchDataFromDOM()));\r\n\t\t\tapp.alertSuccess('[[search:search-preferences-saved]]');\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\t$('#clear-preferences').on('click', function () {\r\n\t\t\tstorage.removeItem('search-preferences');\r\n\t\t\tvar query = $('#search-input').val();\r\n\t\t\t$('#advanced-search')[0].reset();\r\n\t\t\t$('#search-input').val(query);\r\n\t\t\tapp.alertSuccess('[[search:search-preferences-cleared]]');\r\n\t\t\treturn false;\r\n\t\t});\r\n\t}\r\n\r\n\tfunction enableAutoComplete() {\r\n\t\tvar userEl = $('#posted-by-user');\r\n\t\tuserEl.tagsinput({\r\n\t\t\tconfirmKeys: [13, 44],\r\n\t\t\ttrimValue: true,\r\n\t\t});\r\n\t\tautocomplete.user(userEl.siblings('.bootstrap-tagsinput').find('input'));\r\n\r\n\t\tvar tagEl = $('#has-tags');\r\n\t\ttagEl.tagsinput({\r\n\t\t\tconfirmKeys: [13, 44],\r\n\t\t\ttrimValue: true,\r\n\t\t});\r\n\r\n\t\tautocomplete.tag(tagEl.siblings('.bootstrap-tagsinput').find('input'));\r\n\t}\r\n\r\n\treturn Search;\r\n});\r\n"]}