{"version":3,"sources":["public/src/client/topic/images.js"],"names":["define","postTools","navigator","components","Images","_imageLoaderTimeout","undefined","unloadImages","posts","images","find","config","delayImageLoading","each","$","this","attr","wrapImagesInLinks","window","trigger","loadImages","threshold","clearTimeout","setTimeout","get","visible","filter","utils","isElementInViewport","unique","map","parents","scrollTop","adjusting","adjustQueue","oldHeight","newHeight","adjustPosition","document","body","clientHeight","imageRect","getBoundingClientRect","top","length","pop","index","image","on","call","push","bind","removeAttr","$this","src","alt","suffixRegex","isRelativeUrl","test","replace","srcExt","split","slice","altFilename","altExt","parent","is","wrap"],"mappings":"AAAA,aAGAA,OAAO,sBACN,wBACA,YACA,cACE,SAAUC,EAAWC,EAAWC,GAClC,IAAIC,GACHC,oBAAqBC,WAGtBF,EAAOG,aAAe,SAAUC,GAC/B,IAAIC,EAASD,EAAME,KAAK,uDAExB,GAAIC,OAAOC,kBAAmB,CAC7BH,EAAOI,KAAK,WACXC,EAAEC,MAAMC,KAAK,WAAYF,EAAEC,MAAMC,KAAK,UACpCA,KAAK,aAAc,YAAYA,KAAK,MAAO,mBACxC,CACNP,EAAOO,KAAK,aAAc,UAC1BZ,EAAOa,kBAAkBT,GACzBM,EAAEI,QAAQC,QAAQ,0BAIpBf,EAAOgB,WAAa,SAAUC,GAC7B,GAAIjB,EAAOC,oBAAqB,CAC/BiB,aAAalB,EAAOC,qBAGrB,IAAKM,OAAOC,kBAAmB,CAC9B,OAGDR,EAAOC,oBAAsBkB,WAAW,WAUvC,IAAId,EAASN,EAAWqB,IAAI,gBAAgBd,KAAK,8BACjD,IAAIe,EAAUhB,EAAOiB,OAAO,WAC3B,OAAOC,MAAMC,oBAAoBb,QAElC,IAAIP,EAAQM,EAAEe,OAAOJ,EAAQK,IAAI,WAChC,OAAOhB,EAAEC,MAAMgB,QAAQ,sBAAsBP,IAAI,MAElD,IAAIQ,EAAYlB,EAAEI,QAAQc,YAC1B,IAAIC,EAAY,MAChB,IAAIC,KACJ,IAAIC,EACJ,IAAIC,EAEJ,SAASC,IACRJ,EAAY,KACZE,EAAYG,SAASC,KAAKC,aAG1B1B,EAAEC,MAAMC,KAAK,aAAc,UAC3BoB,EAAYE,SAASC,KAAKC,aAE1B,IAAIC,EAAY1B,KAAK2B,wBACrB,GAAID,EAAUE,IAAMtB,EAAW,CAC9BW,GAAaI,EAAYD,EACzBrB,EAAEI,QAAQc,UAAUA,GAGrB,GAAIE,EAAYU,OAAQ,CACvBV,EAAYW,KAAZX,OACM,CACND,EAAY,MAEZ7B,EAAOa,kBAAkBT,GACzBM,EAAEI,QAAQC,QAAQ,wBAClBX,EAAMoC,OAAS,GAKjBnB,EAAQT,KAAK,aAAc,WAC3BS,EAAQZ,KAAK,SAAUiC,EAAOC,GAC7BA,EAAQjC,EAAEiC,GAEVA,EAAMC,GAAG,OAAQ,WAChB,IAAKf,EAAW,CACfI,EAAeY,KAAKlC,UACd,CACNmB,EAAYgB,KAAKb,EAAec,KAAKpC,UAIvCgC,EAAM/B,KAAK,MAAO+B,EAAM/B,KAAK,aAC7B+B,EAAMK,WAAW,eAEhB,MAGJhD,EAAOa,kBAAoB,SAAUT,GACpCA,EAAME,KAAK,8CAA8CG,KAAK,WAC7D,IAAIwC,EAAQvC,EAAEC,MACd,IAAIuC,EAAMD,EAAMrC,KAAK,QAAU,GAC/B,IAAIuC,EAAMF,EAAMrC,KAAK,QAAU,GAC/B,IAAIwC,EAAc,sBAElB,GAAIF,IAAQ,cAAe,CAC1B,OAGD,GAAI3B,MAAM8B,cAAcH,IAAQE,EAAYE,KAAKJ,GAAM,CACtDA,EAAMA,EAAIK,QAAQH,EAAa,MAEhC,IAAII,EAASN,EAAIO,MAAM,KAAKC,MAAM,GAAGjB,MACrC,IAAIkB,EAAcR,EAAIM,MAAM,KAAKhB,MACjC,IAAImB,EAASD,EAAYF,MAAM,KAAKC,MAAM,GAAGjB,MAE7C,IAAKQ,EAAMY,SAASC,GAAG,KAAM,CAC5Bb,EAAMc,KAAK,YAAcb,EAAM,OAC1BM,GAAUI,EAAS,cAAgBD,EAAc,KAAO,IAC1D,0BAMN,OAAO3D","file":"public/src/client/topic/images.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('forum/topic/images', [\r\n\t'forum/topic/postTools',\r\n\t'navigator',\r\n\t'components',\r\n], function (postTools, navigator, components) {\r\n\tvar Images = {\r\n\t\t_imageLoaderTimeout: undefined,\r\n\t};\r\n\r\n\tImages.unloadImages = function (posts) {\r\n\t\tvar images = posts.find('[component=\"post/content\"] img:not(.not-responsive)');\r\n\r\n\t\tif (config.delayImageLoading) {\r\n\t\t\timages.each(function () {\r\n\t\t\t\t$(this).attr('data-src', $(this).attr('src'));\r\n\t\t\t}).attr('data-state', 'unloaded').attr('src', 'about:blank');\r\n\t\t} else {\r\n\t\t\timages.attr('data-state', 'loaded');\r\n\t\t\tImages.wrapImagesInLinks(posts);\r\n\t\t\t$(window).trigger('action:images.loaded');\r\n\t\t}\r\n\t};\r\n\r\n\tImages.loadImages = function (threshold) {\r\n\t\tif (Images._imageLoaderTimeout) {\r\n\t\t\tclearTimeout(Images._imageLoaderTimeout);\r\n\t\t}\r\n\r\n\t\tif (!config.delayImageLoading) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tImages._imageLoaderTimeout = setTimeout(function () {\r\n\t\t\t/*\r\n\t\t\t\tIf threshold is defined, images loaded above this threshold will modify\r\n\t\t\t\tthe user's scroll position so they are not scrolled away from content\r\n\t\t\t\tthey were reading. Images loaded below this threshold will push down content.\r\n\r\n\t\t\t\tIf no threshold is defined, loaded images will push down content, as per\r\n\t\t\t\tdefault\r\n\t\t\t*/\r\n\r\n\t\t\tvar images = components.get('post/content').find('img[data-state=\"unloaded\"]');\r\n\t\t\tvar visible = images.filter(function () {\r\n\t\t\t\treturn utils.isElementInViewport(this);\r\n\t\t\t});\r\n\t\t\tvar posts = $.unique(visible.map(function () {\r\n\t\t\t\treturn $(this).parents('[component=\"post\"]').get(0);\r\n\t\t\t}));\r\n\t\t\tvar scrollTop = $(window).scrollTop();\r\n\t\t\tvar adjusting = false;\r\n\t\t\tvar adjustQueue = [];\r\n\t\t\tvar oldHeight;\r\n\t\t\tvar newHeight;\r\n\r\n\t\t\tfunction adjustPosition() {\r\n\t\t\t\tadjusting = true;\r\n\t\t\t\toldHeight = document.body.clientHeight;\r\n\r\n\t\t\t\t// Display the image\r\n\t\t\t\t$(this).attr('data-state', 'loaded');\r\n\t\t\t\tnewHeight = document.body.clientHeight;\r\n\r\n\t\t\t\tvar imageRect = this.getBoundingClientRect();\r\n\t\t\t\tif (imageRect.top < threshold) {\r\n\t\t\t\t\tscrollTop += newHeight - oldHeight;\r\n\t\t\t\t\t$(window).scrollTop(scrollTop);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (adjustQueue.length) {\r\n\t\t\t\t\tadjustQueue.pop()();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tadjusting = false;\r\n\r\n\t\t\t\t\tImages.wrapImagesInLinks(posts);\r\n\t\t\t\t\t$(window).trigger('action:images.loaded');\r\n\t\t\t\t\tposts.length = 0;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// For each image, reset the source and adjust scrollTop when loaded\r\n\t\t\tvisible.attr('data-state', 'loading');\r\n\t\t\tvisible.each(function (index, image) {\r\n\t\t\t\timage = $(image);\r\n\r\n\t\t\t\timage.on('load', function () {\r\n\t\t\t\t\tif (!adjusting) {\r\n\t\t\t\t\t\tadjustPosition.call(this);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tadjustQueue.push(adjustPosition.bind(this));\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\timage.attr('src', image.attr('data-src'));\r\n\t\t\t\timage.removeAttr('data-src');\r\n\t\t\t});\r\n\t\t}, 250);\r\n\t};\r\n\r\n\tImages.wrapImagesInLinks = function (posts) {\r\n\t\tposts.find('[component=\"post/content\"] img:not(.emoji)').each(function () {\r\n\t\t\tvar $this = $(this);\r\n\t\t\tvar src = $this.attr('src') || '';\r\n\t\t\tvar alt = $this.attr('alt') || '';\r\n\t\t\tvar suffixRegex = /-resized(\\.[\\w]+)?$/;\r\n\r\n\t\t\tif (src === 'about:blank') {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tif (utils.isRelativeUrl(src) && suffixRegex.test(src)) {\r\n\t\t\t\tsrc = src.replace(suffixRegex, '$1');\r\n\t\t\t}\r\n\t\t\tvar srcExt = src.split('.').slice(1).pop();\r\n\t\t\tvar altFilename = alt.split('/').pop();\r\n\t\t\tvar altExt = altFilename.split('.').slice(1).pop();\r\n\r\n\t\t\tif (!$this.parent().is('a')) {\r\n\t\t\t\t$this.wrap('<a href=\"' + src + '\" '\r\n\t\t\t\t\t+ (!srcExt && altExt ? ' download=\"' + altFilename + '\" ' : '')\r\n\t\t\t\t\t+ ' target=\"_blank\" >');\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\r\n\treturn Images;\r\n});\r\n"]}