"use strict";define("chat",["components","taskbar","string","sounds","forum/chats","forum/chats/messages","translator","scrollStop","benchpress"],function(t,a,e,o,n,i,r,d,s){var c={};var u=false;c.prepareDOM=function(){var e=t.get("chat/dropdown");var n=t.get("chat/list");var r=e.parents(".dropdown");e.on("click",function(){if(e.parent().hasClass("open")){return}c.loadChatsDropdown(n)});if(r.hasClass("open")){c.loadChatsDropdown(n)}n.on("click","[data-roomid]",function(t){if($(t.target).parents(".user-link").length){return}var a=$(this).attr("data-roomid");if(!ajaxify.currentPage.match(/^chats\//)){app.openChat(a)}else{ajaxify.go("user/"+app.user.userslug+"/chats/"+a)}});$('[component="chats/mark-all-read"]').on("click",function(){socket.emit("modules.chats.markAllRead",function(t){if(t){return app.alertError(t)}})});socket.on("event:chats.receive",function(t){var e=t.message.fromUser.username;var n=t.self===1;t.message.self=t.self;u=t.self===0;if(c.modalExists(t.roomId)){var r=c.getModal(t.roomId);i.appendChatMessage(r.find(".chat-content"),t.message);if(r.is(":visible")){a.updateActive(r.attr("data-uuid"));i.scrollToBottom(r.find(".chat-content"))}else if(!ajaxify.data.template.chats){c.toggleNew(r.attr("data-uuid"),true,true)}if(!n&&(!r.is(":visible")||!app.isFocused)){app.alternatingTitle("[[modules:chat.user_has_messaged_you, "+e+"]]");o.play("chat-incoming","chat.incoming:"+t.message.mid);a.push("chat",r.attr("data-uuid"),{title:"[[modules:chat.chatting_with]] "+(t.roomName||e),touid:t.message.fromUser.uid,roomId:t.roomId})}}else if(!ajaxify.data.template.chats){socket.emit("modules.chats.loadRoom",{roomId:t.roomId},function(a,i){if(a){return app.alertError(a.message)}i.users=i.users.filter(function(t){return t&&parseInt(t.uid,10)!==parseInt(app.user.uid,10)});i.silent=true;i.uid=app.user.uid;c.createModal(i,function(a){c.toggleNew(a.attr("data-uuid"),!n,true);if(!n){app.alternatingTitle("[[modules:chat.user_has_messaged_you, "+e+"]]");o.play("chat-incoming","chat.incoming:"+t.message.mid)}})})}});socket.on("event:user_status_change",function(t){var a=c.getModal(t.uid);app.updateUserStatus(a.find('[component="user/status"]'),t.status)});socket.on("event:chats.roomRename",function(t){var e=$("<div/>").html(t.newName).text();var o=c.getModal(t.roomId);o.find('[component="chat/room/name"]').text(e);a.updateTitle("chat",o.attr("data-uuid"),e)});i.onChatMessageEdit()};c.loadChatsDropdown=function(t){socket.emit("modules.chats.getRecentChats",{uid:app.user.uid,after:0},function(a,e){if(a){return app.alertError(a.message)}var o=e.rooms.filter(function(t){return t.teaser});s.parse("partials/chats/dropdown",{rooms:o},function(a){r.translate(a,function(a){t.find("*").not(".navigation-link").remove();t.prepend(a);app.createUserTooltips(t,"right")})})})};c.getModal=function(t){return $("#chat-modal-"+t)};c.modalExists=function(t){return $("#chat-modal-"+t).length!==0};c.createModal=function(e,o){app.parseAndTranslate("chat",e,function(i){var r=utils.generateUUID();var s=false;i.attr("id","chat-modal-"+e.roomId);i.attr("data-roomid",e.roomId);i.attr("intervalId",0);i.attr("data-uuid",r);i.css("position","fixed");i.appendTo($("body"));i.find(".timeago").timeago();c.center(i);app.loadJQueryUI(function(){i.find(".modal-content").resizable({handles:"n, e, s, w, se",minHeight:250,minWidth:400});i.find(".modal-content").on("resize",function(t,a){if(a.originalSize.height===a.size.height){return}i.find(".modal-body").css("height",c.calculateChatListHeight(i))});i.draggable({start:function(){a.updateActive(r)},stop:function(){i.find("#chat-message-input").focus()},distance:10,handle:".modal-header"})});d.apply(i.find('[component="chat/messages"]'));i.find("#chat-close-btn").on("click",function(){c.close(i)});function l(){var a=t.get("chat/input").val();$(window).one("action:ajaxify.end",function(){t.get("chat/input").val(a)});ajaxify.go("user/"+app.user.userslug+"/chats/"+i.attr("data-roomid"));c.close(i)}i.find(".modal-header").on("dblclick",l);i.find('button[data-action="maximize"]').on("click",l);i.find('button[data-action="minimize"]').on("click",function(){var t=i.attr("data-uuid");c.minimize(t)});i.on("click",":not(.close)",function(){a.updateActive(i.attr("data-uuid"));if(s){s=false}});i.on("mousemove",function(t){if(t.which===1){s=true}});i.on("mousemove keypress click",function(){if(u){socket.emit("modules.chats.markRead",e.roomId);u=false}});n.addActionHandlers(i.find('[component="chat/messages"]'),e.roomId);n.addRenameHandler(i.attr("data-roomid"),i.find('[data-action="rename"]'),e.roomName);n.addLeaveHandler(i.attr("data-roomid"),i.find('[data-action="leave"]'));n.addSendHandlers(i.attr("data-roomid"),i.find(".chat-input"),i.find('[data-action="send"]'));n.addMemberHandler(i.attr("data-roomid"),i.find('[data-action="members"]'));n.createAutoComplete(i.find('[component="chat/input"]'));n.addScrollHandler(i.attr("data-roomid"),e.uid,i.find(".chat-content"));n.addCharactersLeftHandler(i);n.addIPHandler(i);a.push("chat",i.attr("data-uuid"),{title:"[[modules:chat.chatting_with]] "+(e.roomName||(e.users.length?e.users[0].username:"")),roomId:e.roomId,icon:"fa-comment",state:""});$(window).trigger("action:chat.loaded",i);if(typeof o==="function"){o(i)}})};c.focusInput=function(t){t.find('[component="chat/input"]').focus()};c.close=function(t){clearInterval(t.attr("intervalId"));t.attr("intervalId",0);t.remove();t.data("modal",null);a.discard("chat",t.attr("data-uuid"));if(t.attr("data-mobile")){c.disableMobileBehaviour(t)}};c.center=function(t){var a=false;if(t.hasClass("hide")){t.removeClass("hide");a=true}t.css("left",Math.max(0,($(window).width()-$(t).outerWidth())/2+$(window).scrollLeft())+"px");t.css("top",Math.max(0,$(window).height()/2-$(t).outerHeight()/2)+"px");if(a){t.addClass("hide")}return t};c.load=function(t){var e=$('.chat-modal[data-uuid="'+t+'"]');e.removeClass("hide");a.updateActive(t);i.scrollToBottom(e.find(".chat-content"));c.focusInput(e);socket.emit("modules.chats.markRead",e.attr("data-roomid"));var o=utils.findBootstrapEnvironment();if(o==="xs"||o==="sm"){c.enableMobileBehaviour(e)}};c.enableMobileBehaviour=function(t){app.toggleNavbar(false);t.attr("data-mobile","1");var a=t.find(".modal-body");a.css("height",c.calculateChatListHeight(t));$(window).on("resize",function(){a.css("height",c.calculateChatListHeight(t))})};c.disableMobileBehaviour=function(){app.toggleNavbar(true)};c.calculateChatListHeight=function(t){return t.find(".modal-content").outerHeight()-t.find(".modal-header").outerHeight()};c.minimize=function(t){var e=$('.chat-modal[data-uuid="'+t+'"]');e.addClass("hide");a.minimize("chat",t);clearInterval(e.attr("intervalId"));e.attr("intervalId",0)};c.toggleNew=a.toggleNew;return c});
//# sourceMappingURL=public/src/modules/chat.js.map