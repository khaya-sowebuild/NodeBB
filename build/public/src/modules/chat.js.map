{"version":3,"sources":["public/src/modules/chat.js"],"names":["define","components","taskbar","S","sounds","Chats","ChatsMessages","translator","scrollStop","Benchpress","module","newMessage","prepareDOM","chatsToggleEl","get","chatsListEl","chatsDropdownWrapper","parents","on","parent","hasClass","loadChatsDropdown","ev","$","target","length","roomId","this","attr","ajaxify","currentPage","match","app","openChat","go","user","userslug","socket","emit","err","alertError","data","username","message","fromUser","isSelf","self","modalExists","modal","getModal","appendChatMessage","find","is","updateActive","scrollToBottom","template","chats","toggleNew","isFocused","alternatingTitle","play","mid","push","title","roomName","touid","uid","roomData","users","filter","parseInt","silent","createModal","updateUserStatus","status","newTitle","html","newName","text","updateTitle","onChatMessageEdit","after","rooms","room","teaser","parse","translate","translated","not","remove","prepend","createUserTooltips","callback","parseAndTranslate","chatModal","uuid","utils","generateUUID","dragged","css","appendTo","timeago","center","loadJQueryUI","resizable","handles","minHeight","minWidth","event","ui","originalSize","height","size","calculateChatListHeight","draggable","start","stop","focus","distance","handle","apply","close","gotoChats","val","window","one","minimize","e","which","addActionHandlers","addRenameHandler","addLeaveHandler","addSendHandlers","addMemberHandler","createAutoComplete","addScrollHandler","addCharactersLeftHandler","addIPHandler","icon","state","trigger","focusInput","clearInterval","discard","disableMobileBehaviour","hideAfter","removeClass","Math","max","width","outerWidth","scrollLeft","outerHeight","addClass","load","env","findBootstrapEnvironment","enableMobileBehaviour","modalEl","toggleNavbar","messagesEl"],"mappings":"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","file":"public/src/modules/chat.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('chat', [\r\n\t'components',\r\n\t'taskbar',\r\n\t'string',\r\n\t'sounds',\r\n\t'forum/chats',\r\n\t'forum/chats/messages',\r\n\t'translator',\r\n\t'scrollStop',\r\n\t'benchpress',\r\n], function (components, taskbar, S, sounds, Chats, ChatsMessages, translator, scrollStop, Benchpress) {\r\n\tvar module = {};\r\n\tvar newMessage = false;\r\n\r\n\tmodule.prepareDOM = function () {\r\n\t\tvar chatsToggleEl = components.get('chat/dropdown');\r\n\t\tvar chatsListEl = components.get('chat/list');\r\n\t\tvar chatsDropdownWrapper = chatsToggleEl.parents('.dropdown');\r\n\r\n\t\tchatsToggleEl.on('click', function () {\r\n\t\t\tif (chatsToggleEl.parent().hasClass('open')) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tmodule.loadChatsDropdown(chatsListEl);\r\n\t\t});\r\n\r\n\t\tif (chatsDropdownWrapper.hasClass('open')) {\r\n\t\t\tmodule.loadChatsDropdown(chatsListEl);\r\n\t\t}\r\n\r\n\t\tchatsListEl.on('click', '[data-roomid]', function (ev) {\r\n\t\t\tif ($(ev.target).parents('.user-link').length) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tvar roomId = $(this).attr('data-roomid');\r\n\t\t\tif (!ajaxify.currentPage.match(/^chats\\//)) {\r\n\t\t\t\tapp.openChat(roomId);\r\n\t\t\t} else {\r\n\t\t\t\tajaxify.go('user/' + app.user.userslug + '/chats/' + roomId);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$('[component=\"chats/mark-all-read\"]').on('click', function () {\r\n\t\t\tsocket.emit('modules.chats.markAllRead', function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tsocket.on('event:chats.receive', function (data) {\r\n\t\t\tvar username = data.message.fromUser.username;\r\n\t\t\tvar isSelf = data.self === 1;\r\n\t\t\tdata.message.self = data.self;\r\n\r\n\t\t\tnewMessage = data.self === 0;\r\n\t\t\tif (module.modalExists(data.roomId)) {\r\n\t\t\t\tvar modal = module.getModal(data.roomId);\r\n\r\n\t\t\t\tChatsMessages.appendChatMessage(modal.find('.chat-content'), data.message);\r\n\r\n\t\t\t\tif (modal.is(':visible')) {\r\n\t\t\t\t\ttaskbar.updateActive(modal.attr('data-uuid'));\r\n\t\t\t\t\tChatsMessages.scrollToBottom(modal.find('.chat-content'));\r\n\t\t\t\t} else if (!ajaxify.data.template.chats) {\r\n\t\t\t\t\tmodule.toggleNew(modal.attr('data-uuid'), true, true);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!isSelf && (!modal.is(':visible') || !app.isFocused)) {\r\n\t\t\t\t\tapp.alternatingTitle('[[modules:chat.user_has_messaged_you, ' + username + ']]');\r\n\t\t\t\t\tsounds.play('chat-incoming', 'chat.incoming:' + data.message.mid);\r\n\r\n\t\t\t\t\ttaskbar.push('chat', modal.attr('data-uuid'), {\r\n\t\t\t\t\t\ttitle: '[[modules:chat.chatting_with]] ' + (data.roomName || username),\r\n\t\t\t\t\t\ttouid: data.message.fromUser.uid,\r\n\t\t\t\t\t\troomId: data.roomId,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} else if (!ajaxify.data.template.chats) {\r\n\t\t\t\tsocket.emit('modules.chats.loadRoom', {\r\n\t\t\t\t\troomId: data.roomId,\r\n\t\t\t\t}, function (err, roomData) {\r\n\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\troomData.users = roomData.users.filter(function (user) {\r\n\t\t\t\t\t\treturn user && parseInt(user.uid, 10) !== parseInt(app.user.uid, 10);\r\n\t\t\t\t\t});\r\n\t\t\t\t\troomData.silent = true;\r\n\t\t\t\t\troomData.uid = app.user.uid;\r\n\t\t\t\t\tmodule.createModal(roomData, function (modal) {\r\n\t\t\t\t\t\tmodule.toggleNew(modal.attr('data-uuid'), !isSelf, true);\r\n\t\t\t\t\t\tif (!isSelf) {\r\n\t\t\t\t\t\t\tapp.alternatingTitle('[[modules:chat.user_has_messaged_you, ' + username + ']]');\r\n\t\t\t\t\t\t\tsounds.play('chat-incoming', 'chat.incoming:' + data.message.mid);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tsocket.on('event:user_status_change', function (data) {\r\n\t\t\tvar modal = module.getModal(data.uid);\r\n\t\t\tapp.updateUserStatus(modal.find('[component=\"user/status\"]'), data.status);\r\n\t\t});\r\n\r\n\t\tsocket.on('event:chats.roomRename', function (data) {\r\n\t\t\tvar newTitle = $('<div/>').html(data.newName).text();\r\n\t\t\tvar modal = module.getModal(data.roomId);\r\n\t\t\tmodal.find('[component=\"chat/room/name\"]').text(newTitle);\r\n\t\t\ttaskbar.updateTitle('chat', modal.attr('data-uuid'), newTitle);\r\n\t\t});\r\n\r\n\t\tChatsMessages.onChatMessageEdit();\r\n\t};\r\n\r\n\tmodule.loadChatsDropdown = function (chatsListEl) {\r\n\t\tsocket.emit('modules.chats.getRecentChats', {\r\n\t\t\tuid: app.user.uid,\r\n\t\t\tafter: 0,\r\n\t\t}, function (err, data) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tvar rooms = data.rooms.filter(function (room) {\r\n\t\t\t\treturn room.teaser;\r\n\t\t\t});\r\n\r\n\t\t\tBenchpress.parse('partials/chats/dropdown', {\r\n\t\t\t\trooms: rooms,\r\n\t\t\t}, function (html) {\r\n\t\t\t\ttranslator.translate(html, function (translated) {\r\n\t\t\t\t\tchatsListEl.find('*').not('.navigation-link').remove();\r\n\t\t\t\t\tchatsListEl.prepend(translated);\r\n\t\t\t\t\tapp.createUserTooltips(chatsListEl, 'right');\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tmodule.getModal = function (roomId) {\r\n\t\treturn $('#chat-modal-' + roomId);\r\n\t};\r\n\r\n\tmodule.modalExists = function (roomId) {\r\n\t\treturn $('#chat-modal-' + roomId).length !== 0;\r\n\t};\r\n\r\n\tmodule.createModal = function (data, callback) {\r\n\t\tapp.parseAndTranslate('chat', data, function (chatModal) {\r\n\t\t\tvar uuid = utils.generateUUID();\r\n\t\t\tvar dragged = false;\r\n\r\n\t\t\tchatModal.attr('id', 'chat-modal-' + data.roomId);\r\n\t\t\tchatModal.attr('data-roomid', data.roomId);\r\n\t\t\tchatModal.attr('intervalId', 0);\r\n\t\t\tchatModal.attr('data-uuid', uuid);\r\n\t\t\tchatModal.css('position', 'fixed');\r\n\t\t\tchatModal.appendTo($('body'));\r\n\t\t\tchatModal.find('.timeago').timeago();\r\n\t\t\tmodule.center(chatModal);\r\n\r\n\t\t\tapp.loadJQueryUI(function () {\r\n\t\t\t\tchatModal.find('.modal-content').resizable({\r\n\t\t\t\t\thandles: 'n, e, s, w, se',\r\n\t\t\t\t\tminHeight: 250,\r\n\t\t\t\t\tminWidth: 400,\r\n\t\t\t\t});\r\n\r\n\t\t\t\tchatModal.find('.modal-content').on('resize', function (event, ui) {\r\n\t\t\t\t\tif (ui.originalSize.height === ui.size.height) {\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tchatModal.find('.modal-body').css('height', module.calculateChatListHeight(chatModal));\r\n\t\t\t\t});\r\n\r\n\t\t\t\tchatModal.draggable({\r\n\t\t\t\t\tstart: function () {\r\n\t\t\t\t\t\ttaskbar.updateActive(uuid);\r\n\t\t\t\t\t},\r\n\t\t\t\t\tstop: function () {\r\n\t\t\t\t\t\tchatModal.find('#chat-message-input').focus();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tdistance: 10,\r\n\t\t\t\t\thandle: '.modal-header',\r\n\t\t\t\t});\r\n\t\t\t});\r\n\r\n\t\t\tscrollStop.apply(chatModal.find('[component=\"chat/messages\"]'));\r\n\r\n\t\t\tchatModal.find('#chat-close-btn').on('click', function () {\r\n\t\t\t\tmodule.close(chatModal);\r\n\t\t\t});\r\n\r\n\t\t\tfunction gotoChats() {\r\n\t\t\t\tvar text = components.get('chat/input').val();\r\n\t\t\t\t$(window).one('action:ajaxify.end', function () {\r\n\t\t\t\t\tcomponents.get('chat/input').val(text);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tajaxify.go('user/' + app.user.userslug + '/chats/' + chatModal.attr('data-roomid'));\r\n\t\t\t\tmodule.close(chatModal);\r\n\t\t\t}\r\n\r\n\t\t\tchatModal.find('.modal-header').on('dblclick', gotoChats);\r\n\t\t\tchatModal.find('button[data-action=\"maximize\"]').on('click', gotoChats);\r\n\t\t\tchatModal.find('button[data-action=\"minimize\"]').on('click', function () {\r\n\t\t\t\tvar uuid = chatModal.attr('data-uuid');\r\n\t\t\t\tmodule.minimize(uuid);\r\n\t\t\t});\r\n\r\n\t\t\tchatModal.on('click', ':not(.close)', function () {\r\n\t\t\t\ttaskbar.updateActive(chatModal.attr('data-uuid'));\r\n\r\n\t\t\t\tif (dragged) {\r\n\t\t\t\t\tdragged = false;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tchatModal.on('mousemove', function (e) {\r\n\t\t\t\tif (e.which === 1) {\r\n\t\t\t\t\tdragged = true;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tchatModal.on('mousemove keypress click', function () {\r\n\t\t\t\tif (newMessage) {\r\n\t\t\t\t\tsocket.emit('modules.chats.markRead', data.roomId);\r\n\t\t\t\t\tnewMessage = false;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tChats.addActionHandlers(chatModal.find('[component=\"chat/messages\"]'), data.roomId);\r\n\t\t\tChats.addRenameHandler(chatModal.attr('data-roomid'), chatModal.find('[data-action=\"rename\"]'), data.roomName);\r\n\t\t\tChats.addLeaveHandler(chatModal.attr('data-roomid'), chatModal.find('[data-action=\"leave\"]'));\r\n\t\t\tChats.addSendHandlers(chatModal.attr('data-roomid'), chatModal.find('.chat-input'), chatModal.find('[data-action=\"send\"]'));\r\n\t\t\tChats.addMemberHandler(chatModal.attr('data-roomid'), chatModal.find('[data-action=\"members\"]'));\r\n\r\n\t\t\tChats.createAutoComplete(chatModal.find('[component=\"chat/input\"]'));\r\n\r\n\t\t\tChats.addScrollHandler(chatModal.attr('data-roomid'), data.uid, chatModal.find('.chat-content'));\r\n\r\n\t\t\tChats.addCharactersLeftHandler(chatModal);\r\n\t\t\tChats.addIPHandler(chatModal);\r\n\r\n\t\t\ttaskbar.push('chat', chatModal.attr('data-uuid'), {\r\n\t\t\t\ttitle: '[[modules:chat.chatting_with]] ' + (data.roomName || (data.users.length ? data.users[0].username : '')),\r\n\t\t\t\troomId: data.roomId,\r\n\t\t\t\ticon: 'fa-comment',\r\n\t\t\t\tstate: '',\r\n\t\t\t});\r\n\r\n\t\t\t$(window).trigger('action:chat.loaded', chatModal);\r\n\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(chatModal);\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tmodule.focusInput = function (chatModal) {\r\n\t\tchatModal.find('[component=\"chat/input\"]').focus();\r\n\t};\r\n\r\n\tmodule.close = function (chatModal) {\r\n\t\tclearInterval(chatModal.attr('intervalId'));\r\n\t\tchatModal.attr('intervalId', 0);\r\n\t\tchatModal.remove();\r\n\t\tchatModal.data('modal', null);\r\n\t\ttaskbar.discard('chat', chatModal.attr('data-uuid'));\r\n\r\n\t\tif (chatModal.attr('data-mobile')) {\r\n\t\t\tmodule.disableMobileBehaviour(chatModal);\r\n\t\t}\r\n\t};\r\n\r\n\tmodule.center = function (chatModal) {\r\n\t\tvar hideAfter = false;\r\n\t\tif (chatModal.hasClass('hide')) {\r\n\t\t\tchatModal.removeClass('hide');\r\n\t\t\thideAfter = true;\r\n\t\t}\r\n\t\tchatModal.css('left', Math.max(0, (($(window).width() - $(chatModal).outerWidth()) / 2) + $(window).scrollLeft()) + 'px');\r\n\t\tchatModal.css('top', Math.max(0, ($(window).height() / 2) - ($(chatModal).outerHeight() / 2)) + 'px');\r\n\r\n\t\tif (hideAfter) {\r\n\t\t\tchatModal.addClass('hide');\r\n\t\t}\r\n\t\treturn chatModal;\r\n\t};\r\n\r\n\tmodule.load = function (uuid) {\r\n\t\tvar chatModal = $('.chat-modal[data-uuid=\"' + uuid + '\"]');\r\n\t\tchatModal.removeClass('hide');\r\n\t\ttaskbar.updateActive(uuid);\r\n\t\tChatsMessages.scrollToBottom(chatModal.find('.chat-content'));\r\n\t\tmodule.focusInput(chatModal);\r\n\t\tsocket.emit('modules.chats.markRead', chatModal.attr('data-roomid'));\r\n\r\n\t\tvar env = utils.findBootstrapEnvironment();\r\n\t\tif (env === 'xs' || env === 'sm') {\r\n\t\t\tmodule.enableMobileBehaviour(chatModal);\r\n\t\t}\r\n\t};\r\n\r\n\tmodule.enableMobileBehaviour = function (modalEl) {\r\n\t\tapp.toggleNavbar(false);\r\n\t\tmodalEl.attr('data-mobile', '1');\r\n\t\tvar messagesEl = modalEl.find('.modal-body');\r\n\t\tmessagesEl.css('height', module.calculateChatListHeight(modalEl));\r\n\r\n\t\t$(window).on('resize', function () {\r\n\t\t\tmessagesEl.css('height', module.calculateChatListHeight(modalEl));\r\n\t\t});\r\n\t};\r\n\r\n\tmodule.disableMobileBehaviour = function () {\r\n\t\tapp.toggleNavbar(true);\r\n\t};\r\n\r\n\tmodule.calculateChatListHeight = function (modalEl) {\r\n\t\t// Formula: modal height minus header height. Simple(tm).\r\n\t\treturn modalEl.find('.modal-content').outerHeight() - modalEl.find('.modal-header').outerHeight();\r\n\t};\r\n\r\n\tmodule.minimize = function (uuid) {\r\n\t\tvar chatModal = $('.chat-modal[data-uuid=\"' + uuid + '\"]');\r\n\t\tchatModal.addClass('hide');\r\n\t\ttaskbar.minimize('chat', uuid);\r\n\t\tclearInterval(chatModal.attr('intervalId'));\r\n\t\tchatModal.attr('intervalId', 0);\r\n\t};\r\n\r\n\tmodule.toggleNew = taskbar.toggleNew;\r\n\r\n\r\n\treturn module;\r\n});\r\n"]}