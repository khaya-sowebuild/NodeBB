{"version":3,"sources":["node_modules/nodebb-plugin-composer-default/static/lib/composer.js"],"names":["define","taskbar","translator","controls","uploads","formatting","drafts","tags","categoryList","preview","resize","autocomplete","scrollStop","composer","active","undefined","posts","bsEnvironment","$","window","off","onWindowResize","on","ev","data","localStorage","removeItem","cid","env","utils","findBootstrapEnvironment","modified","discard","discardConfirm","length","modal","translate","translated","bootbox","confirm","removeComposerHistory","ajaxify","template","compose","history","back","reposition","location","pathname","startsWith","mobileHistoryAppend","alreadyOpen","post","type","id","hasOwnProperty","uuid","push","generateUUID","existingUUID","updateActive","load","actionText","action","translatedAction","title","replace","parseInt","app","user","uid","save_id","join","tid","pid","updateVisibility","composerAlert","post_uuid","message","find","removeAttr","alert","timeout","alert_id","findByTid","addButton","iconClass","onClick","newTopic","pushData","body","isMain","trigger","addQuote","toPid","selectedPid","username","text","escapedTitle","link","config","relative_path","newReply","postContainer","bodyEl","prevText","val","defaultLang","onTranslated","focusElements","render","editPost","socket","emit","err","threadData","alertError","activate","onShow","createNewComposer","options","enhance","postData","attr","draft","getDraft","submitBtn","init","addHandler","addComposerButtons","handleToggler","removeClass","allowFileUploads","initialize","allowTopicsThumbnail","toggleThumbEls","thumb","e","preventDefault","stopPropagation","this","keypress","event","keyCode","which","ctrlKey","btn","prop","matchScroll","handleHelp","screenfull","enabled","addClass","isTopic","isEditing","isGuestPost","mobile","resizable","isTopicOrMain","minimumTagLength","maximumTagLength","showHandleInput","allowGuestHandles","isAdmin","handle","tagWhitelist","privileges","toggleNavbar","createData","parseAndTranslate","composerTemplate","each","unescape","document","append","isActive","handleResize","submitBtns","mobileSubmitBtn","textareaEl","idx","toggleClass","composerData","apply","path","returnPath","slice","replaceState","url","pushState","helpBtn","html","minimize","setTimeout","focus","putCursorAtEnd","handleEl","titleEl","thumbEl","onComposeRoute","trim","rtrim","checkTitle","isCategorySelected","inProgress","minimumTitleLength","maximumTitleLength","getTags","minimumTagsPerTopic","minimumPostLength","maximumPostLength","content","getSelectedCid","composerEl","taskbarIconEl","showEmailConfirmWarning","removeDraft","queued","go","slug","topic","onHide","css","paddingBottom","textcomplete","remove"],"mappings":"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","file":"node_modules/nodebb-plugin-composer-default/static/lib/composer.js","sourcesContent":["'use strict';\r\n\r\n/* globals define, socket, app, config, ajaxify, utils, bootbox, screenfull */\r\n\r\ndefine('composer', [\r\n\t'taskbar',\r\n\t'translator',\r\n\t'composer/controls',\r\n\t'composer/uploads',\r\n\t'composer/formatting',\r\n\t'composer/drafts',\r\n\t'composer/tags',\r\n\t'composer/categoryList',\r\n\t'composer/preview',\r\n\t'composer/resize',\r\n\t'composer/autocomplete',\r\n\t'scrollStop'\r\n], function(taskbar, translator, controls, uploads, formatting, drafts, tags, categoryList, preview, resize, autocomplete, scrollStop) {\r\n\tvar composer = {\r\n\t\tactive: undefined,\r\n\t\tposts: {},\r\n\t\tbsEnvironment: undefined,\r\n\t\tformatting: undefined,\r\n\t};\r\n\r\n\t$(window).off('resize', onWindowResize).on('resize', onWindowResize);\r\n\tonWindowResize();\r\n\r\n\t$(window).on('action:composer.topics.post', function(ev, data) {\r\n\t\tlocalStorage.removeItem('category:' + data.data.cid + ':bookmark');\r\n\t\tlocalStorage.removeItem('category:' + data.data.cid + ':bookmark:clicked');\r\n\t});\r\n\r\n\t$(window).on('popstate', function() {\r\n\t\tvar env = utils.findBootstrapEnvironment();\r\n\t\tif (composer.active && (env === 'xs' || env ==='sm')) {\r\n\t\t\tif (!composer.posts[composer.active].modified) {\r\n\t\t\t\tcomposer.discard(composer.active);\r\n\t\t\t\tif (composer.discardConfirm && composer.discardConfirm.length) {\r\n\t\t\t\t\tcomposer.discardConfirm.modal('hide');\r\n\t\t\t\t\tdelete composer.discardConfirm;\r\n\t\t\t\t}\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\ttranslator.translate('[[modules:composer.discard]]', function(translated) {\r\n\t\t\t\tcomposer.discardConfirm = bootbox.confirm(translated, function(confirm) {\r\n\t\t\t\t\tif (confirm) {\r\n\t\t\t\t\t\tcomposer.discard(composer.active);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tcomposer.posts[composer.active].modified = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tcomposer.posts[composer.active].modified = false;\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n\r\n\tfunction removeComposerHistory() {\r\n\t\tvar env = composer.bsEnvironment;\r\n\t\tif (ajaxify.data.template.compose === true || env === 'xs' || env ==='sm') {\r\n\t\t\thistory.back();\r\n\t\t}\r\n\t}\r\n\r\n\tfunction onWindowResize() {\r\n\t\tvar env = utils.findBootstrapEnvironment();\r\n\t\tif (composer.active !== undefined) {\r\n\t\t\tresize.reposition($('.composer[data-uuid=\"' + composer.active + '\"]'));\r\n\r\n\t\t\tif ((env === 'md' || env === 'lg') && window.location.pathname.startsWith('/compose')) {\r\n\t\t\t\t/*\r\n\t\t\t\t *\tIf this conditional is met, we're no longer in mobile/tablet\r\n\t\t\t\t *\tresolution but we've somehow managed to have a mobile\r\n\t\t\t\t *\tcomposer load, so let's go back to the topic\r\n\t\t\t\t */\r\n\t\t\t\thistory.back();\r\n\t\t\t} else if ((env === 'xs' || env === 'sm') && !window.location.pathname.startsWith('/compose')) {\r\n\t\t\t\t/*\r\n\t\t\t\t *\tIn this case, we're in mobile/tablet resolution but the composer\r\n\t\t\t\t *\tthat loaded was a regular composer, so let's fix the address bar\r\n\t\t\t\t */\r\n\t\t\t\tmobileHistoryAppend();\r\n\t\t\t}\r\n\t\t}\r\n\t\tcomposer.bsEnvironment = env;\r\n\t}\r\n\r\n\tfunction alreadyOpen(post) {\r\n\t\t// If a composer for the same cid/tid/pid is already open, return the uuid, else return bool false\r\n\t\tvar\ttype, id;\r\n\r\n\t\tif (post.hasOwnProperty('cid')) {\r\n\t\t\ttype = 'cid';\r\n\t\t} else if (post.hasOwnProperty('tid')) {\r\n\t\t\ttype = 'tid';\r\n\t\t} else if (post.hasOwnProperty('pid')) {\r\n\t\t\ttype = 'pid';\r\n\t\t}\r\n\r\n\t\tid = post[type];\r\n\r\n\t\t// Find a match\r\n\t\tfor(var uuid in composer.posts) {\r\n\t\t\tif (composer.posts[uuid].hasOwnProperty(type) && id === composer.posts[uuid][type]) {\r\n\t\t\t\treturn uuid;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// No matches...\r\n\t\treturn false;\r\n\t}\r\n\r\n\tfunction push(post) {\r\n\t\tvar uuid = utils.generateUUID(),\r\n\t\t\texistingUUID = alreadyOpen(post);\r\n\r\n\t\tif (existingUUID) {\r\n\t\t\ttaskbar.updateActive(existingUUID);\r\n\t\t\treturn composer.load(existingUUID);\r\n\t\t}\r\n\r\n\t\tvar actionText = '[[topic:composer.new_topic]]';\r\n\t\tif (post.action === 'posts.reply') {\r\n\t\t\tactionText = '[[topic:composer.replying_to]]';\r\n\t\t} else if (post.action === 'posts.edit') {\r\n\t\t\tactionText = '[[topic:composer.editing]]';\r\n\t\t}\r\n\r\n\t\ttranslator.translate(actionText, function(translatedAction) {\r\n\t\t\ttaskbar.push('composer', uuid, {\r\n\t\t\t\ttitle: translatedAction.replace('%1', '\"' + post.title + '\"')\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\t// Construct a save_id\r\n\t\tif (0 !== parseInt(app.user.uid, 10)) {\r\n\t\t\tif (post.hasOwnProperty('cid')) {\r\n\t\t\t\tpost.save_id = ['composer', app.user.uid, 'cid', post.cid].join(':');\r\n\t\t\t} else if (post.hasOwnProperty('tid')) {\r\n\t\t\t\tpost.save_id = ['composer', app.user.uid, 'tid', post.tid].join(':');\r\n\t\t\t} else if (post.hasOwnProperty('pid')) {\r\n\t\t\t\tpost.save_id = ['composer', app.user.uid, 'pid', post.pid].join(':');\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Post is opened, save to list of opened drafts\r\n\t\tdrafts.updateVisibility('available', post.save_id, true);\r\n\t\tdrafts.updateVisibility('open', post.save_id, true);\r\n\r\n\t\tcomposer.posts[uuid] = post;\r\n\t\tcomposer.load(uuid);\r\n\t}\r\n\r\n\tfunction composerAlert(post_uuid, message) {\r\n\t\t$('.composer[data-uuid=\"' + post_uuid + '\"]').find('.composer-submit').removeAttr('disabled');\r\n\t\tapp.alert({\r\n\t\t\ttype: 'danger',\r\n\t\t\ttimeout: 3000,\r\n\t\t\ttitle: '',\r\n\t\t\tmessage: message,\r\n\t\t\talert_id: 'post_error'\r\n\t\t});\r\n\t}\r\n\r\n\tcomposer.findByTid = function(tid) {\r\n\t\t// Iterates through the initialised composers and returns the uuid of the matching composer\r\n\t\tfor(var uuid in composer.posts) {\r\n\t\t\tif (composer.posts.hasOwnProperty(uuid) && composer.posts[uuid].hasOwnProperty('tid') && parseInt(composer.posts[uuid].tid, 10) === parseInt(tid, 10)) {\r\n\t\t\t\treturn uuid;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t};\r\n\r\n\tcomposer.addButton = function(iconClass, onClick, title) {\r\n\t\tformatting.addButton(iconClass, onClick, title);\r\n\t};\r\n\r\n\tcomposer.newTopic = function(data) {\r\n\t\tvar pushData = {\r\n\t\t\taction: 'topics.post',\r\n\t\t\tcid: data.cid,\r\n\t\t\ttitle: data.title || '',\r\n\t\t\tbody: data.body || '',\r\n\t\t\ttags: data.tags || [],\r\n\t\t\tmodified: false,\r\n\t\t\tisMain: true\r\n\t\t};\r\n\r\n\t\t$(window).trigger('filter:composer.topic.push', {\r\n\t\t\tdata: data,\r\n\t\t\tpushData: pushData\r\n\t\t});\r\n\r\n\t\tpush(pushData);\r\n\t};\r\n\r\n\tcomposer.addQuote = function(tid, toPid, selectedPid, title, username, text, uuid) {\r\n\t\tuuid = uuid || composer.active;\r\n\r\n\t\tvar escapedTitle = (title || '').replace(/([\\\\`*_{}\\[\\]()#+\\-.!])/g, '\\\\$1').replace(/\\[/g, '&#91;').replace(/\\]/g, '&#93;').replace(/%/g, '&#37;').replace(/,/g, '&#44;');\r\n\r\n\t\tif (text) {\r\n\t\t\ttext = '> ' + text.replace(/\\n/g, '\\n> ') + '\\n\\n';\r\n\t\t}\r\n\t\tvar link = '[' + escapedTitle + '](' + config.relative_path + '/post/' + (selectedPid || toPid) + ')';\r\n\t\tif (uuid === undefined) {\r\n\t\t\tif (title && (selectedPid || toPid)) {\r\n\t\t\t\tcomposer.newReply(tid, toPid, title, '[[modules:composer.user_said_in, ' + username + ', ' + link + ']]\\n' + text);\r\n\t\t\t} else {\r\n\t\t\t\tcomposer.newReply(tid, toPid, title, '[[modules:composer.user_said, ' + username + ']]\\n' + text);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t} else if (uuid !== composer.active) {\r\n\t\t\t// If the composer is not currently active, activate it\r\n\t\t\tcomposer.load(uuid);\r\n\t\t}\r\n\r\n\t\tvar postContainer = $('.composer[data-uuid=\"' + uuid + '\"]');\r\n\t\tvar bodyEl = postContainer.find('textarea');\r\n\t\tvar prevText = bodyEl.val();\r\n\t\tif (title && (selectedPid || toPid)) {\r\n\t\t\ttranslator.translate('[[modules:composer.user_said_in, ' + username + ', ' + link + ']]\\n', config.defaultLang, onTranslated);\r\n\t\t} else {\r\n\t\t\ttranslator.translate('[[modules:composer.user_said, ' + username + ']]\\n', config.defaultLang, onTranslated);\r\n\t\t}\r\n\r\n\t\tfunction onTranslated(translated) {\r\n\t\t\tcomposer.posts[uuid].body = (prevText.length ? prevText + '\\n\\n' : '') + translated + text;\r\n\t\t\tbodyEl.val(composer.posts[uuid].body);\r\n\t\t\tfocusElements(postContainer);\r\n\t\t\tpreview.render(postContainer);\r\n\t\t}\r\n\t};\r\n\r\n\tcomposer.newReply = function(tid, toPid, title, text) {\r\n\t\ttranslator.translate(text, config.defaultLang, function(translated) {\r\n\t\t\tpush({\r\n\t\t\t\taction: 'posts.reply',\r\n\t\t\t\ttid: tid,\r\n\t\t\t\ttoPid: toPid,\r\n\t\t\t\ttitle: title,\r\n\t\t\t\tbody: translated,\r\n\t\t\t\tmodified: false,\r\n\t\t\t\tisMain: false\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tcomposer.editPost = function(pid) {\r\n\t\tsocket.emit('plugins.composer.push', pid, function(err, threadData) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\t\t\tthreadData.action = 'posts.edit';\r\n\t\t\tthreadData.pid = pid;\r\n\t\t\tthreadData.modified = false;\r\n\t\t\tpush(threadData);\r\n\t\t});\r\n\t};\r\n\r\n\tcomposer.load = function(post_uuid) {\r\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\r\n\t\tif (postContainer.length) {\r\n\t\t\tactivate(post_uuid);\r\n\t\t\tresize.reposition(postContainer);\r\n\t\t\tfocusElements(postContainer);\r\n\t\t\tonShow();\r\n\t\t} else {\r\n\t\t\tif (composer.formatting) {\r\n\t\t\t\tcreateNewComposer(post_uuid);\r\n\t\t\t} else {\r\n\t\t\t\tsocket.emit('plugins.composer.getFormattingOptions', function(err, options) {\r\n\t\t\t\t\tcomposer.formatting = options;\r\n\t\t\t\t\tcreateNewComposer(post_uuid);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tcomposer.enhance = function(postContainer, post_uuid, postData) {\r\n\t\t/*\r\n\t\t\tThis method enhances a composer container with client-side sugar (preview, etc)\r\n\t\t\tEverything in here also applies to the /compose route\r\n\t\t*/\r\n\r\n\t\tif (!post_uuid && !postData) {\r\n\t\t\tpost_uuid = utils.generateUUID();\r\n\t\t\tcomposer.posts[post_uuid] = postData = ajaxify.data;\r\n\t\t\tpostContainer.attr('data-uuid', post_uuid);\r\n\t\t}\r\n\r\n\t\tvar bodyEl = postContainer.find('textarea');\r\n\t\tvar draft = drafts.getDraft(postData.save_id);\r\n\t\tvar submitBtn = postContainer.find('.composer-submit');\r\n\r\n\t\tcategoryList.init(postContainer, composer.posts[post_uuid]);\r\n\r\n\t\tformatting.addHandler(postContainer);\r\n\t\tformatting.addComposerButtons();\r\n\t\tpreview.handleToggler(postContainer);\r\n\r\n\t\tpostContainer.find('.img-upload-btn').removeClass('hide');\r\n\t\tpostContainer.find('#files.lt-ie9').removeClass('hide');\r\n\r\n\t\tif (config.allowFileUploads) {\r\n\t\t\tpostContainer.find('.file-upload-btn').removeClass('hide');\r\n\t\t\tpostContainer.find('#files.lt-ie9').removeClass('hide');\r\n\t\t}\r\n\r\n\t\tuploads.initialize(post_uuid);\r\n\r\n\t\tif (config.allowTopicsThumbnail && postData.isMain) {\r\n\t\t\tuploads.toggleThumbEls(postContainer, composer.posts[post_uuid].thumb || '');\r\n\t\t}\r\n\r\n\t\ttags.init(postContainer, composer.posts[post_uuid]);\r\n\r\n\t\tautocomplete.init(postContainer, post_uuid);\r\n\r\n\t\tpostContainer.on('change', 'input, textarea', function() {\r\n\t\t\tcomposer.posts[post_uuid].modified = true;\r\n\t\t});\r\n\r\n\t\tsubmitBtn.on('click', function(e) {\r\n\t\t\te.preventDefault();\r\n\t\t\te.stopPropagation();\t// Other click events bring composer back to active state which is undesired on submit\r\n\r\n\t\t\t$(this).attr('disabled', true);\r\n\t\t\tpost(post_uuid);\r\n\t\t});\r\n\r\n\t\tpostContainer.keypress(function (event) {\r\n\t\t\tvar keyCode = (event.which ? event.which : event.keyCode);\r\n\t\t\tif ((keyCode === 10 || keyCode == 13) && event.ctrlKey) {\r\n\t\t\t\tsubmitBtn.attr('disabled', true);\r\n\t\t\t\tpost(post_uuid);\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\treturn true;\r\n\t\t});\r\n\r\n\t\tpostContainer.find('.composer-discard').on('click', function(e) {\r\n\t\t\te.preventDefault();\r\n\r\n\t\t\tif (!composer.posts[post_uuid].modified) {\r\n\t\t\t\tcomposer.discard(post_uuid);\r\n\t\t\t\treturn removeComposerHistory();\r\n\t\t\t}\r\n\r\n\t\t\tvar btn = $(this).prop('disabled', true);\r\n\t\t\ttranslator.translate('[[modules:composer.discard]]', function(translated) {\r\n\t\t\t\tbootbox.confirm(translated, function(confirm) {\r\n\t\t\t\t\tif (confirm) {\r\n\t\t\t\t\t\tcomposer.discard(post_uuid);\r\n\t\t\t\t\t\tremoveComposerHistory();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbtn.prop('disabled', false);\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tbodyEl.on('input propertychange', function() {\r\n\t\t\tpreview.render(postContainer);\r\n\t\t});\r\n\r\n\t\tbodyEl.on('scroll', function() {\r\n\t\t\tpreview.matchScroll(postContainer);\r\n\t\t});\r\n\r\n\t\tpreview.render(postContainer, function() {\r\n\t\t\tpreview.matchScroll(postContainer);\r\n\t\t});\r\n\r\n\t\tbodyEl.val(draft ? draft : postData.body);\r\n\t\tif (app.user.uid > 0) {\r\n\t\t\tdrafts.init(postContainer, postData);\r\n\t\t}\r\n\r\n\t\thandleHelp(postContainer);\r\n\r\n\t\tfocusElements(postContainer);\r\n\r\n\t\t// Hide \"zen mode\" if fullscreen API is not enabled/available (ahem, iOS...)\r\n\t\tif (typeof screenfull !== 'undefined' && !screenfull.enabled) {\r\n\t\t\t$('[data-format=\"zen\"]').addClass('hidden');\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:composer.enhanced', {\r\n\t\t\tpostContainer: postContainer\r\n\t\t});\r\n\t};\r\n\r\n\tfunction createNewComposer(post_uuid) {\r\n\t\tvar postData = composer.posts[post_uuid];\r\n\r\n\t\tvar allowTopicsThumbnail = config.allowTopicsThumbnail && postData.isMain,\r\n\t\t\tisTopic = postData ? postData.hasOwnProperty('cid') : false,\r\n\t\t\tisMain = postData ? !!postData.isMain : false,\r\n\t\t\tisEditing = postData ? !!postData.pid : false,\r\n\t\t\tisGuestPost = postData ? parseInt(postData.uid, 10) === 0 : false;\r\n\r\n\t\t// see\r\n\t\t// https://github.com/NodeBB/NodeBB/issues/2994 and\r\n\t\t// https://github.com/NodeBB/NodeBB/issues/1951\r\n\t\t// remove when 1951 is resolved\r\n\r\n\t\tvar title = postData.title.replace(/%/g, '&#37;').replace(/,/g, '&#44;');\r\n\r\n\t\tvar data = {\r\n\t\t\ttitle: title,\r\n\t\t\tmobile: composer.bsEnvironment === 'xs' || composer.bsEnvironment === 'sm',\r\n\t\t\tresizable: true,\r\n\t\t\tallowTopicsThumbnail: allowTopicsThumbnail,\r\n\t\t\tisTopicOrMain: isTopic || isMain,\r\n\t\t\tminimumTagLength: config.minimumTagLength,\r\n\t\t\tmaximumTagLength: config.maximumTagLength,\r\n\t\t\tisTopic: isTopic,\r\n\t\t\tisEditing: isEditing,\r\n\t\t\tshowHandleInput:  config.allowGuestHandles && (app.user.uid === 0 || (isEditing && isGuestPost && app.user.isAdmin)),\r\n\t\t\thandle: postData ? postData.handle || '' : undefined,\r\n\t\t\tformatting: composer.formatting,\r\n\t\t\ttagWhitelist: ajaxify.data.tagWhitelist,\r\n\t\t\tprivileges: app.user.privileges,\r\n\t\t};\r\n\r\n\t\tif (data.mobile) {\r\n\t\t\tmobileHistoryAppend();\r\n\r\n\t\t\tapp.toggleNavbar(false);\r\n\t\t}\r\n\r\n\t\tpostData.mobile = composer.bsEnvironment === 'xs' || composer.bsEnvironment === 'sm';\r\n\r\n\t\t$(window).trigger('filter:composer.create', {\r\n\t\t\tpostData: postData,\r\n\t\t\tcreateData: data\r\n\t\t});\r\n\r\n\t\tapp.parseAndTranslate('composer', data, function(composerTemplate) {\r\n\t\t\tif ($('.composer.composer[data-uuid=\"' + post_uuid + '\"]').length) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tcomposerTemplate = $(composerTemplate);\r\n\r\n\t\t\tcomposerTemplate.find('.title').each(function () {\r\n\t\t\t\t$(this).text(translator.unescape($(this).text()));\r\n\t\t\t});\r\n\r\n\t\t\tcomposerTemplate.attr('data-uuid', post_uuid);\r\n\r\n\t\t\t$(document.body).append(composerTemplate);\r\n\r\n\t\t\tvar postContainer = $(composerTemplate[0]);\r\n\r\n\t\t\tresize.reposition(postContainer);\r\n\t\t\tcomposer.enhance(postContainer, post_uuid, postData);\r\n\t\t\t/*\r\n\t\t\t\tEverything after this line is applied to the resizable composer only\r\n\t\t\t\tWant something done to both resizable composer and the one in /compose?\r\n\t\t\t\tPut it in composer.enhance().\r\n\r\n\t\t\t\tEventually, stuff after this line should be moved into composer.enhance().\r\n\t\t\t*/\r\n\r\n\t\t\tactivate(post_uuid);\r\n\r\n\t\t\tpostContainer.on('click', function() {\r\n\t\t\t\tif (!taskbar.isActive(post_uuid)) {\r\n\t\t\t\t\ttaskbar.updateActive(post_uuid);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tresize.handleResize(postContainer);\r\n\r\n\t\t\tif (composer.bsEnvironment === 'xs' || composer.bsEnvironment === 'sm') {\r\n\t\t\t\tvar submitBtns = postContainer.find('.composer-submit'),\r\n\t\t\t\t\tmobileSubmitBtn = postContainer.find('.mobile-navbar .composer-submit'),\r\n\t\t\t\t\ttextareaEl = postContainer.find('.write'),\r\n\t\t\t\t\tidx = textareaEl.attr('tabindex');\r\n\r\n\t\t\t\tsubmitBtns.removeAttr('tabindex');\r\n\t\t\t\tmobileSubmitBtn.attr('tabindex', parseInt(idx, 10)+1);\r\n\r\n\t\t\t\t$('.category-name-container').on('click', function() {\r\n\t\t\t\t\t$('.category-selector').toggleClass('open');\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\t$(window).trigger('action:composer.loaded', {\r\n\t\t\t\tpost_uuid: post_uuid,\r\n\t\t\t\tcomposerData: composer.posts[post_uuid],\r\n\t\t\t\tformatting: composer.formatting,\r\n\t\t\t});\r\n\r\n\t\t\tscrollStop.apply(postContainer.find('.write'));\r\n\t\t\tfocusElements(postContainer);\r\n\t\t\tonShow();\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tfunction mobileHistoryAppend() {\r\n\t\tvar path = 'compose?p=' + window.location.pathname,\r\n\t\t\treturnPath = window.location.pathname.slice(1);\r\n\r\n\t\t// Remove relative path from returnPath\r\n\t\tif (returnPath.startsWith(config.relative_path.slice(1))) {\r\n\t\t\treturnPath = returnPath.slice(config.relative_path.length);\r\n\t\t}\r\n\r\n\t\t// Add in return path to be caught by ajaxify when post is completed, or if back is pressed\r\n\t\twindow.history.replaceState({\r\n\t\t\turl: null,\r\n\t\t\treturnPath: returnPath\r\n\t\t}, returnPath, config.relative_path + '/' + returnPath);\r\n\r\n\t\t// Update address bar in case f5 is pressed\r\n\t\twindow.history.pushState({\r\n\t\t\turl: path\r\n\t\t}, path, config.relative_path + '/' + path);\r\n\t}\r\n\r\n\tfunction handleHelp(postContainer) {\r\n\t\tvar helpBtn = postContainer.find('.help');\r\n\t\tsocket.emit('plugins.composer.renderHelp', function(err, html) {\r\n\t\t\tif (!err && html && html.length > 0) {\r\n\t\t\t\thelpBtn.removeClass('hidden');\r\n\t\t\t\thelpBtn.on('click', function() {\r\n\t\t\t\t\tbootbox.alert(html);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction activate(post_uuid) {\r\n\t\tif(composer.active && composer.active !== post_uuid) {\r\n\t\t\tcomposer.minimize(composer.active);\r\n\t\t}\r\n\r\n\t\tcomposer.active = post_uuid;\r\n\t}\r\n\r\n\tfunction focusElements(postContainer) {\r\n\t\tsetTimeout(function() {\r\n\t\t\tvar title = postContainer.find('input.title');\r\n\r\n\t\t\tif (title.length) {\r\n\t\t\t\ttitle.focus();\r\n\t\t\t} else {\r\n\t\t\t\tpostContainer.find('textarea').focus().putCursorAtEnd();\r\n\t\t\t}\r\n\t\t}, 1);\r\n\t}\r\n\r\n\tfunction post(post_uuid) {\r\n\t\tvar postData = composer.posts[post_uuid];\r\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\r\n\t\tvar handleEl = postContainer.find('.handle');\r\n\t\tvar titleEl = postContainer.find('.title');\r\n\t\tvar bodyEl = postContainer.find('textarea');\r\n\t\tvar thumbEl = postContainer.find('input#topic-thumb-url');\r\n\t\tvar onComposeRoute = postData.hasOwnProperty('template') && postData.template.compose === true;\r\n\r\n\t\ttitleEl.val(titleEl.val().trim());\r\n\t\tbodyEl.val(utils.rtrim(bodyEl.val()));\r\n\t\tif (thumbEl.length) {\r\n\t\t\tthumbEl.val(thumbEl.val().trim());\r\n\t\t}\r\n\r\n\t\tvar action = postData.action;\r\n\r\n\t\tvar checkTitle = (postData.hasOwnProperty('cid') || parseInt(postData.pid, 10)) && postContainer.find('input.title').length;\r\n\t\tvar isCategorySelected = !checkTitle || (checkTitle && parseInt(postData.cid, 10));\r\n\r\n\t\tif (uploads.inProgress[post_uuid] && uploads.inProgress[post_uuid].length) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:still-uploading]]');\r\n\t\t} else if (checkTitle && titleEl.val().length < parseInt(config.minimumTitleLength, 10)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:title-too-short, ' + config.minimumTitleLength + ']]');\r\n\t\t} else if (checkTitle && titleEl.val().length > parseInt(config.maximumTitleLength, 10)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:title-too-long, ' + config.maximumTitleLength + ']]');\r\n\t\t} else if (action === 'topics.post' && !isCategorySelected) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:category-not-selected]]');\r\n\t\t} else if (checkTitle && tags.getTags(post_uuid) && tags.getTags(post_uuid).length < parseInt(config.minimumTagsPerTopic, 10)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:not-enough-tags, ' + config.minimumTagsPerTopic + ']]');\r\n\t\t} else if (bodyEl.val().length < parseInt(config.minimumPostLength, 10)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:content-too-short, ' + config.minimumPostLength + ']]');\r\n\t\t} else if (bodyEl.val().length > parseInt(config.maximumPostLength, 10)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:content-too-long, ' + config.maximumPostLength + ']]');\r\n\t\t}\r\n\r\n\t\tvar composerData = {};\r\n\r\n\t\tif (action === 'topics.post') {\r\n\t\t\tcomposerData = {\r\n\t\t\t\thandle: handleEl ? handleEl.val() : undefined,\r\n\t\t\t\ttitle: titleEl.val(),\r\n\t\t\t\tcontent: bodyEl.val(),\r\n\t\t\t\tthumb: thumbEl.val() || '',\r\n\t\t\t\tcid: categoryList.getSelectedCid(),\r\n\t\t\t\ttags: tags.getTags(post_uuid)\r\n\t\t\t};\r\n\t\t} else if (action === 'posts.reply') {\r\n\t\t\tcomposerData = {\r\n\t\t\t\ttid: postData.tid,\r\n\t\t\t\thandle: handleEl ? handleEl.val() : undefined,\r\n\t\t\t\tcontent: bodyEl.val(),\r\n\t\t\t\ttoPid: postData.toPid\r\n\t\t\t};\r\n\t\t} else if (action === 'posts.edit') {\r\n\t\t\tcomposerData = {\r\n\t\t\t\tpid: postData.pid,\r\n\t\t\t\thandle: handleEl ? handleEl.val() : undefined,\r\n\t\t\t\tcontent: bodyEl.val(),\r\n\t\t\t\ttitle: titleEl.val(),\r\n\t\t\t\tthumb: thumbEl.val() || '',\r\n\t\t\t\ttags: tags.getTags(post_uuid)\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:composer.submit', {\r\n\t\t\tcomposerEl: postContainer,\r\n\t\t\taction: action,\r\n\t\t\tcomposerData: composerData,\r\n\t\t\tpostData: postData\r\n\t\t});\r\n\r\n\t\t// Minimize composer (and set textarea as readonly) while submitting\r\n\t\tvar taskbarIconEl = $('#taskbar .composer[data-uuid=\"' + post_uuid + '\"] i');\r\n\t\tvar textareaEl = postContainer.find('.write');\r\n\t\ttaskbarIconEl.removeClass('fa-plus').addClass('fa-circle-o-notch fa-spin');\r\n\t\tcomposer.minimize(post_uuid);\r\n\t\ttextareaEl.prop('readonly', true);\r\n\r\n\t\tsocket.emit(action, composerData, function (err, data) {\r\n\t\t\tpostContainer.find('.composer-submit').removeAttr('disabled');\r\n\t\t\tif (err) {\r\n\t\t\t\tif (err.message === '[[error:email-not-confirmed]]') {\r\n\t\t\t\t\treturn app.showEmailConfirmWarning(err);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Restore composer on error\r\n\t\t\t\tcomposer.load(post_uuid);\r\n\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tcomposer.discard(post_uuid);\r\n\t\t\tdrafts.removeDraft(postData.save_id);\r\n\r\n\t\t\tif (data.queued) {\r\n\t\t\t\tbootbox.alert(data.message);\r\n\t\t\t} else {\r\n\t\t\t\tif (action === 'topics.post') {\r\n\t\t\t\t\tajaxify.go('topic/' + data.slug, undefined, (onComposeRoute || composer.bsEnvironment === 'xs' || composer.bsEnvironment === 'sm') ? true : false);\r\n\t\t\t\t} else if (action === 'posts.reply') {\r\n\t\t\t\t\tif (onComposeRoute || composer.bsEnvironment === 'xs' || composer.bsEnvironment === 'sm') {\r\n\t\t\t\t\t\twindow.history.back();\r\n\t\t\t\t\t} else if (ajaxify.data.template.topic) {\r\n\t\t\t\t\t\tif (parseInt(postData.tid, 10) !== parseInt(ajaxify.data.tid, 10)) {\r\n\t\t\t\t\t\t\tajaxify.go('post/' + data.pid);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// else, we're in the same topic, no nav required\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tajaxify.go('post/' + data.pid);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tremoveComposerHistory();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t$(window).trigger('action:composer.' + action, { composerData: composerData, data: data });\r\n\t\t});\r\n\t}\r\n\r\n\tfunction onShow() {\r\n\t\t$('html').addClass('composing');\r\n\t}\r\n\r\n\tfunction onHide() {\r\n\t\t$('body').css({ paddingBottom: 0 });\r\n\t\t$('html').removeClass('composing');\r\n\t\tapp.toggleNavbar(true);\r\n\t}\r\n\r\n\tcomposer.discard = function(post_uuid) {\r\n\t\tif (composer.posts[post_uuid]) {\r\n\t\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\r\n\t\t\tpostContainer.find('.write').textcomplete('destroy');\r\n\t\t\tpostContainer.remove();\r\n\t\t\tdrafts.removeDraft(composer.posts[post_uuid].save_id);\r\n\r\n\t\t\tdelete composer.posts[post_uuid];\r\n\t\t\tcomposer.active = undefined;\r\n\t\t\ttaskbar.discard('composer', post_uuid);\r\n\t\t\t$('[data-action=\"post\"]').removeAttr('disabled');\r\n\r\n\t\t\t$(window).trigger('action:composer.discard');\r\n\t\t}\r\n\t\tonHide();\r\n\t};\r\n\r\n\tcomposer.minimize = function(post_uuid) {\r\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\r\n\t\tpostContainer.css('visibility', 'hidden');\r\n\t\tcomposer.active = undefined;\r\n\t\ttaskbar.minimize('composer', post_uuid);\r\n\r\n\t\tonHide();\r\n\t};\r\n\r\n\treturn composer;\r\n});\r\n"]}