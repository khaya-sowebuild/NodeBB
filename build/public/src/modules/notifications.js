"use strict";define("notifications",["sounds","translator","components","navigator","benchpress"],function(t,a,n,i,e){var o={};var r={};o.prepareDOM=function(){var a=n.get("notifications");var i=a.children("a");var e=n.get("notifications/list");var c=i.parents(".dropdown");i.on("click",function(t){t.preventDefault();if(a.hasClass("open")){return}o.loadNotifications(e)});if(c.hasClass("open")){o.loadNotifications(e)}e.on("click","[data-nid]",function(t){var a=$(this);if(f(a)){t.stopPropagation();t.preventDefault();i.dropdown("toggle")}var n=a.hasClass("unread");if(!n){return}var e=a.attr("data-nid");s(e,true)});a.on("click",".mark-all-read",o.markAllRead);e.on("click",".mark-read",function(){var t=$(this).parent();var a=t.hasClass("unread");var n=t.attr("data-nid");s(n,a,function(){t.toggleClass("unread")});return false});socket.on("event:new_notification",function(a){var n={alert_id:"new_notif",title:"[[notifications:new_notification]]",timeout:parseInt(config.notificationAlertTimeout,10)||5e3};if(a.path){n.message=a.bodyShort;n.type="info";n.clickfn=function(){s(a.nid,true);if(a.path.startsWith("http")||a.path.startsWith("https")){window.location.href=a.path}else{window.location.href=window.location.protocol+"//"+window.location.host+config.relative_path+a.path}}}else{n.message="[[notifications:you_have_unread_notifications]]";n.type="warning"}app.alert(n);app.refreshTitle();if(ajaxify.currentPage==="notifications"){ajaxify.refresh()}socket.emit("notifications.getCount",function(t,a){if(t){return app.alertError(t.message)}o.updateNotifCount(a)});if(!r[a.nid]){t.play("notification",a.nid);r[a.nid]=true}});socket.on("event:notifications.updateCount",function(t){o.updateNotifCount(t)})};function s(t,a,n){socket.emit("notifications.mark"+(a?"Read":"Unread"),t,function(i){if(i){return app.alertError(i.message)}if(a&&r[t]){delete r[t]}if(n){n()}})}function f(t){var a=t.attr("data-pid");var e=t.attr("data-path");var o=n.get("post","pid",a);if(e.startsWith(config.relative_path+"/post/")&&a&&o.length&&ajaxify.data.template.topic){i.scrollToIndex(o.attr("data-index"),true);return true}return false}o.loadNotifications=function(t){socket.emit("notifications.get",null,function(n,i){if(n){return app.alertError(n.message)}var o=i.unread.concat(i.read).sort(function(t,a){return parseInt(t.datetime,10)>parseInt(a.datetime,10)?-1:1});a.toggleTimeagoShorthand(function(){for(var n=0;n<o.length;n+=1){o[n].timeago=$.timeago(new Date(parseInt(o[n].datetime,10)))}a.toggleTimeagoShorthand();e.parse("partials/notifications_list",{notifications:o},function(a){t.translateHtml(a)})})})};o.updateNotifCount=function(t){var a=n.get("notifications/icon");t=Math.max(0,t);if(t>0){a.removeClass("fa-bell-o").addClass("fa-bell")}else{a.removeClass("fa-bell").addClass("fa-bell-o")}a.toggleClass("unread-count",t>0);a.attr("data-content",t>99?"99+":t);var i={count:t,updateFavicon:true};$(window).trigger("action:notification.updateCount",i);if(i.updateFavicon){Tinycon.setBubble(t>99?"99+":t)}};o.markAllRead=function(){socket.emit("notifications.markAllRead",function(t){if(t){app.alertError(t.message)}r={}})};return o});
//# sourceMappingURL=public/src/modules/notifications.js.map