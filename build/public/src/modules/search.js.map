{"version":3,"sources":["public/src/modules/search.js"],"names":["define","nav","translator","storage","Search","current","query","data","callback","topicSearch","term","match","ajaxify","go","createQueryString","cleanedTerm","replace","tid","length","queryTopic","searchIn","in","postedBy","by","encodeURIComponent","e","app","alertError","matchWords","categories","searchChildren","hasTags","parseInt","replies","repliesFilter","timeRange","timeFilter","sortBy","sortDirection","showAs","$","window","trigger","decodeURIComponent","param","getSearchPreferences","JSON","parse","getItem","socket","emit","err","pids","message","Array","isArray","results","sort","a","b","checkPagePresence","topicDOM","update","active","prev","index","next","topicSearchEl","start","find","html","removeAttr","pid","topicPostSort","config","postIndex","scrollToIndex","translate","text","removeClass","attr","require","mousetrap","bind","end","addClass","unbind"],"mappings":"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","file":"public/src/modules/search.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('search', ['navigator', 'translator', 'storage'], function (nav, translator, storage) {\r\n\tvar Search = {\r\n\t\tcurrent: {},\r\n\t};\r\n\r\n\tSearch.query = function (data, callback) {\r\n\t\t// Detect if a tid was specified\r\n\t\tvar topicSearch = data.term.match(/^in:topic-([\\d]+) /);\r\n\r\n\t\tif (!topicSearch) {\r\n\t\t\tajaxify.go('search?' + createQueryString(data));\r\n\t\t\tcallback();\r\n\t\t} else {\r\n\t\t\tvar cleanedTerm = data.term.replace(topicSearch[0], '');\r\n\t\t\tvar tid = topicSearch[1];\r\n\r\n\t\t\tif (cleanedTerm.length > 0) {\r\n\t\t\t\tSearch.queryTopic(tid, cleanedTerm, callback);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tfunction createQueryString(data) {\r\n\t\tvar searchIn = data.in || 'titlesposts';\r\n\t\tvar postedBy = data.by || '';\r\n\t\tvar term = data.term.replace(/^[ ?#]*/, '');\r\n\t\ttry {\r\n\t\t\tterm = encodeURIComponent(term);\r\n\t\t} catch (e) {\r\n\t\t\treturn app.alertError('[[error:invalid-search-term]]');\r\n\t\t}\r\n\r\n\t\tvar query = {\r\n\t\t\tterm: term,\r\n\t\t\tin: searchIn,\r\n\t\t};\r\n\r\n\t\tif (data.matchWords) {\r\n\t\t\tquery.matchWords = data.matchWords;\r\n\t\t}\r\n\r\n\t\tif (postedBy && postedBy.length && (searchIn === 'posts' || searchIn === 'titles' || searchIn === 'titlesposts')) {\r\n\t\t\tquery.by = postedBy;\r\n\t\t}\r\n\r\n\t\tif (data.categories && data.categories.length) {\r\n\t\t\tquery.categories = data.categories;\r\n\t\t\tif (data.searchChildren) {\r\n\t\t\t\tquery.searchChildren = data.searchChildren;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (data.hasTags && data.hasTags.length) {\r\n\t\t\tquery.hasTags = data.hasTags;\r\n\t\t}\r\n\r\n\t\tif (parseInt(data.replies, 10) > 0) {\r\n\t\t\tquery.replies = data.replies;\r\n\t\t\tquery.repliesFilter = data.repliesFilter || 'atleast';\r\n\t\t}\r\n\r\n\t\tif (data.timeRange) {\r\n\t\t\tquery.timeRange = data.timeRange;\r\n\t\t\tquery.timeFilter = data.timeFilter || 'newer';\r\n\t\t}\r\n\r\n\t\tif (data.sortBy) {\r\n\t\t\tquery.sortBy = data.sortBy;\r\n\t\t\tquery.sortDirection = data.sortDirection;\r\n\t\t}\r\n\r\n\t\tif (data.showAs) {\r\n\t\t\tquery.showAs = data.showAs;\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:search.createQueryString', {\r\n\t\t\tquery: query,\r\n\t\t\tdata: data,\r\n\t\t});\r\n\r\n\t\treturn decodeURIComponent($.param(query));\r\n\t}\r\n\r\n\tSearch.getSearchPreferences = function () {\r\n\t\ttry {\r\n\t\t\treturn JSON.parse(storage.getItem('search-preferences') || '{}');\r\n\t\t} catch (e) {\r\n\t\t\treturn {};\r\n\t\t}\r\n\t};\r\n\r\n\tSearch.queryTopic = function (tid, term) {\r\n\t\tsocket.emit('topics.search', {\r\n\t\t\ttid: tid,\r\n\t\t\tterm: term,\r\n\t\t}, function (err, pids) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tif (Array.isArray(pids)) {\r\n\t\t\t\t// Sort pids numerically & store\r\n\t\t\t\tSearch.current = {\r\n\t\t\t\t\tresults: pids.sort(function (a, b) {\r\n\t\t\t\t\t\treturn a - b;\r\n\t\t\t\t\t}),\r\n\t\t\t\t\ttid: tid,\r\n\t\t\t\t\tterm: term,\r\n\t\t\t\t};\r\n\r\n\t\t\t\tSearch.checkPagePresence(tid, function () {\r\n\t\t\t\t\tSearch.topicDOM.update(0);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tSearch.checkPagePresence = function (tid, callback) {\r\n\t\tif (parseInt(ajaxify.data.tid, 10) !== parseInt(tid, 10)) {\r\n\t\t\tajaxify.go('topic/' + tid, callback);\r\n\t\t} else {\r\n\t\t\tcallback();\r\n\t\t}\r\n\t};\r\n\r\n\tSearch.topicDOM = {\r\n\t\tactive: false,\r\n\t};\r\n\r\n\tSearch.topicDOM.prev = function () {\r\n\t\tSearch.topicDOM.update((Search.current.index === 0) ? Search.current.results.length - 1 : Search.current.index - 1);\r\n\t};\r\n\r\n\tSearch.topicDOM.next = function () {\r\n\t\tSearch.topicDOM.update((Search.current.index === Search.current.results.length - 1) ? 0 : Search.current.index + 1);\r\n\t};\r\n\r\n\tSearch.topicDOM.update = function (index) {\r\n\t\tvar topicSearchEl = $('.topic-search');\r\n\t\tSearch.current.index = index;\r\n\r\n\t\tSearch.topicDOM.start();\r\n\r\n\t\tif (Search.current.results.length > 0) {\r\n\t\t\ttopicSearchEl.find('.count').html((index + 1) + ' / ' + Search.current.results.length);\r\n\t\t\ttopicSearchEl.find('.prev, .next').removeAttr('disabled');\r\n\t\t\tvar data = {\r\n\t\t\t\tpid: Search.current.results[index],\r\n\t\t\t\ttid: Search.current.tid,\r\n\t\t\t\ttopicPostSort: config.topicPostSort,\r\n\t\t\t};\r\n\t\t\tsocket.emit('posts.getPidIndex', data, function (err, postIndex) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnav.scrollToIndex(postIndex, true);\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\ttranslator.translate('[[search:no-matches]]', function (text) {\r\n\t\t\t\ttopicSearchEl.find('.count').html(text);\r\n\t\t\t});\r\n\t\t\ttopicSearchEl.removeClass('hidden').find('.prev, .next').attr('disabled', 'disabled');\r\n\t\t}\r\n\t};\r\n\r\n\tSearch.topicDOM.start = function () {\r\n\t\t$('.topic-search').removeClass('hidden');\r\n\t\tif (!Search.topicDOM.active) {\r\n\t\t\tSearch.topicDOM.active = true;\r\n\r\n\t\t\t// Bind to esc\r\n\t\t\trequire(['mousetrap'], function (mousetrap) {\r\n\t\t\t\tmousetrap.bind('esc', Search.topicDOM.end);\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n\r\n\tSearch.topicDOM.end = function () {\r\n\t\t$('.topic-search').addClass('hidden').find('.prev, .next').attr('disabled', 'disabled');\r\n\t\tSearch.topicDOM.active = false;\r\n\r\n\t\t// Unbind esc\r\n\t\trequire(['mousetrap'], function (mousetrap) {\r\n\t\t\tmousetrap.unbind('esc', Search.topicDOM.end);\r\n\t\t});\r\n\t};\r\n\r\n\treturn Search;\r\n});\r\n"]}