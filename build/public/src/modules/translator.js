"use strict";(function(e){function t(e,t){return Promise.resolve(jQuery.getJSON(config.relative_path+"/assets/language/"+e+"/"+t+".json?"+config["cache-buster"]))}var r=function(){console.warn.apply(console,arguments)};if(typeof define==="function"&&define.amd){define("translator",[],function(){return e(utils,t,r)})}else if(typeof module==="object"&&module.exports){(function(){var t=require("../../../src/languages");if(global.env==="development"){var n=require("winston");r=function(e){n.warn(e)}}function a(e,r){return new Promise(function(n,a){t.get(e,r,function(e,t){if(e){a(e)}else{n(t)}})})}module.exports=e(require("../utils"),a,r)})()}})(function(e,t,r){var n=Object.assign||jQuery.extend;function a(t){return e.escapeHTML(e.decodeHTMLEntities(String(t).replace(/[\s\xa0]+/g," ").replace(/^\s+|\s+$/g,"")))}var i=function(){function n(e){var t=this;if(!e){throw new TypeError("Parameter `language` must be a language string. Received "+e+(e===""?"(empty string)":""))}t.modules=Object.keys(n.moduleFactories).map(function(t){var r=n.moduleFactories[t];return[t,r(e)]}).reduce(function(e,t){var r=t[0];var n=t[1];e[r]=n;return e},{});t.lang=e;t.translations={}}n.prototype.load=t;n.prototype.translate=function e(t){var r="a-zA-Z0-9\\-_.\\/";var n=new RegExp("["+r+"]");var a=new RegExp("[^"+r+"\\]]");var i=0;var s=0;var o=t.length;var u=[];var l=false;function c(e){var t=e.length;var r=[];var n=0;var a=0;var i=0;while(n+2<=t){if(e[n]==="["&&e[n+1]==="["){i+=1;n+=1}else if(e[n]==="]"&&e[n+1]==="]"){i-=1;n+=1}else if(i===0&&e[n]===","&&e[n-1]!=="\\"){r.push(e.slice(a,n).trim());n+=1;a=n}n+=1}r.push(e.slice(a,n+1).trim());return r}i=t.indexOf("[[",i);while(i+2<=o&&i!==-1){u.push(t.slice(s,i));i+=2;s=i;l=true;var f=0;var g;var v;var p=false;var h=false;var m=false;var d=false;while(i+2<=o){g=t[i];v=t[i+1];if(!p&&n.test(g)){p=true;i+=1}else if(p&&!h&&g===":"){h=true;i+=1}else if(h&&!m&&n.test(g)){m=true;i+=1}else if(m&&!d&&g===","){d=true;i+=1}else if(!(p&&h&&m&&d)&&a.test(g)){i+=1;s-=2;l=false;if(f>0){f-=1}else{break}}else if(g==="["&&v==="["){f+=1;i+=2}else if(g==="]"&&v==="]"){if(f===0){var y=t.slice(s,i);var j=c(y);var w=j[0];var b=j.slice(1);var T="";if(b&&b.length){T=this.translate(y)}u.push(this.translateKey(w,b,T));i+=2;s=i;l=false;break}f-=1;i+=2}else{i+=1}}i=t.indexOf("[[",i)}var q=t.slice(s);if(l){q=this.translate(q)}u.push(q);return Promise.all(u).then(function(e){return e.join("")})};n.prototype.translateKey=function e(t,n,i){var s=this;var o=t.split(":",2);var u=o[0];var l=o[1];if(s.modules[u]){return Promise.resolve(s.modules[u](l,n))}if(u&&!l){r('Missing key in translation token "'+t+'"');return Promise.resolve("[["+u+"]]")}var c=this.getTranslation(u,l);return c.then(function(e){if(!e){r('Missing translation "'+t+'"');return i||l}var o=n.map(function(e){return s.translate(a(e))});return Promise.all(o).then(function(t){var r=e;t.forEach(function(e,t){var n=e.replace(/%(?=\d)/g,"&#37;").replace(/\\,/g,"&#44;");r=r.replace(new RegExp("%"+(t+1),"g"),n)});return r})})};n.prototype.getTranslation=function e(t,n){var a;if(!t){r("[translator] Parameter `namespace` is "+t+(t===""?"(empty string)":""));a=Promise.resolve({})}else{this.translations[t]=this.translations[t]||this.load(this.lang,t).catch(function(){return{}});a=this.translations[t]}if(n){return a.then(function(e){return e[n]})}return a};function i(e){var t=[];function r(e){if(e.nodeType===3){t.push(e)}else{for(var n=0,a=e.childNodes,i=a.length;n<i;n+=1){r(a[n])}}}r(e);return t}n.prototype.translateInPlace=function e(t,r){r=r||["placeholder","title"];var n=i(t);var a=n.map(function(e){return e.nodeValue}).join("  ||  ");var s=r.reduce(function(e,r){var n=Array.prototype.map.call(t.querySelectorAll("["+r+'*="[["]'),function(e){return[r,e]});return e.concat(n)},[]);var o=s.map(function(e){return e[1].getAttribute(e[0])}).join("  ||  ");return Promise.all([this.translate(a),this.translate(o)]).then(function(e){var t=e[0];var r=e[1];if(t){t.split("  ||  ").forEach(function(e,t){$(n[t]).replaceWith(e)})}if(r){r.split("  ||  ").forEach(function(e,t){s[t][1].setAttribute(s[t][0],e)})}})};n.getLanguage=function t(){var r;if(typeof window==="object"&&window.config&&window.utils){r=e.params().lang||config.userLang||config.defaultLang||"en-GB"}else{var n=require("../../../src/meta");r=n.config.defaultLang||"en-GB"}return r};n.create=function e(t){if(!t){t=n.getLanguage()}n.cache[t]=n.cache[t]||new n(t);return n.cache[t]};n.cache={};n.registerModule=function e(t,r){n.moduleFactories[t]=r;Object.keys(n.cache).forEach(function(e){var a=n.cache[e];a.modules[t]=r(a.lang)})};n.moduleFactories={};n.removePatterns=function e(t){var r=t.length;var n=0;var a=0;var i=0;var s="";var o;while(n<r){o=t.slice(n,n+2);if(o==="[["){if(i===0){s+=t.slice(a,n)}i+=1;n+=2}else if(o==="]]"){i-=1;n+=2;if(i===0){a=n}}else{n+=1}}s+=t.slice(a,n);return s};n.escape=function e(t){return typeof t==="string"?t.replace(/\[\[/g,"&lsqb;&lsqb;").replace(/\]\]/g,"&rsqb;&rsqb;"):t};n.unescape=function e(t){return typeof t==="string"?t.replace(/&lsqb;|\\\[/g,"[").replace(/&rsqb;|\\\]/g,"]"):t};n.compile=function e(){var t=Array.prototype.slice.call(arguments,0).map(function(e){return String(e).replace(/%/g,"&#37;").replace(/,/g,"&#44;")});return"[["+t.join(", ")+"]]"};return n}();var s={Translator:i,compile:i.compile,escape:i.escape,unescape:i.unescape,getLanguage:i.getLanguage,translate:function e(t,n,a){var s=a;var o=n;if(typeof n==="function"){s=n;o=null}if(!(typeof t==="string"||t instanceof String)||t===""){return s("")}return i.create(o).translate(t).then(function(e){if(s){setTimeout(s,0,e)}return e},function(e){r("Translation failed: "+e.stack)})},addTranslation:function e(t,r,a){i.create(t).getTranslation(r).then(function(e){n(e,a)})},getTranslations:function e(t,r,n){n=n||function(){};i.create(t).getTranslation(r).then(n)},load:function e(t,r,n){s.getTranslations(t,r,n)},toggleTimeagoShorthand:function t(r){function a(){var e=n({},jQuery.timeago.settings.strings);jQuery.timeago.settings.strings=n({},s.timeagoShort);s.timeagoShort=n({},e);if(typeof r==="function"){r()}}if(!s.timeagoShort){var i=e.userLangToTimeagoCode(config.userLang);var o=n({},jQuery.timeago.settings.strings);jQuery.getScript(config.relative_path+"/assets/vendor/jquery/timeago/locales/jquery.timeago."+i+"-short.js").done(function(){s.timeagoShort=n({},jQuery.timeago.settings.strings);jQuery.timeago.settings.strings=n({},o);a()})}else{a()}},prepareDOM:function e(){s.translate("[[language:dir]]",function(e){if(e&&!$("html").attr("data-dir")){jQuery("html").css("direction",e).attr("data-dir",e)}})}};return s});
//# sourceMappingURL=public/src/modules/translator.js.map